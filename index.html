<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>豪情在天 · 任务与计时</title>
<meta name="theme-color" content="#f5f5f7">
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="豪情计时">
<link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23007aff'/%3E%3Cpath d='M25 50 L45 70 L75 30' stroke='white' stroke-width='10' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<style>
  :root{
    --bg: #f5f5f7;
    --panel: #ffffff;
    --panel-2: #fdfdfd;
    --text: #1d1d1f;
    --muted: #666;
    --primary: #007aff;
    --primary-hover: #0071e3;
    --accent: #007aff;
    --danger: #ff3b30;
    --danger-hover: #ff453a;
    --success: #34c759;
    --warning: #ff9500;
    --border: #dcdcdc;
    --ring-bg: #e5e5ea;
    --shadow: 0 4px 12px rgba(0,0,0,.08);
    --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  *{box-sizing:border-box}
  html{background-color:var(--bg)}
  html,body{height:100%}
  body{margin:0;font-family:var(--font-sans);color:var(--text);background:var(--bg); text-rendering: optimizeLegibility; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;}
  .app{max-width:1220px;margin:30px auto 60px;padding:0 16px; animation: fadeIn .5s .1s ease-out forwards; opacity:0;}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
  h1{font-size:28px;margin:0;font-weight:800}
  h2{font-size:18px;font-weight:700;margin:0 0 1em}
  h3{font-size:16px;font-weight:600;margin:0 0 .8em}
  h4{font-weight:700}
  .workspace{display:grid;gap:28px;grid-template-columns:minmax(0,1.3fr) minmax(380px,0.7fr)}
  .column{display:flex;flex-direction:column;gap:24px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
  .card.compact .bd{padding:16px 24px}
  .card .hd{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--panel);}
  .card .bd{padding:24px}
  .control-dock{display:grid;gap:16px}
  .control-group{border:1px solid var(--border);border-radius:10px;padding:14px;background:#fdfdfd}
  .control-group h4{margin:0 0 12px;font-size:11px;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;font-weight:600}
  .dock-buttons{display:flex;flex-wrap:wrap;gap:10px}
  .dock-buttons .btn{flex:1;min-width:120px;text-align:center}
  .muted{color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  input,select{background: #fdfdfd;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:12px 14px;outline:none;font-family:inherit;font-size:15px;transition:border-color .2s ease,box-shadow .2s ease}
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in srgb,var(--accent) 25%,transparent)}
  .btn{appearance:none;border:none;background:#e9e9eb;color:var(--text);padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-family:inherit;font-size:15px;transition:background-color .2s ease, transform .1s ease;}
  .btn:hover{background-color:#dadadf}
  .btn:active{transform:scale(.98)}
  .btn.primary{background:var(--primary);border:none;color:#fff}
  .btn.primary:hover{background:var(--primary-hover)}
  .btn.accent{background:var(--accent);border:none;color:#fff}
  .btn.accent:hover{background:color-mix(in srgb,var(--accent) 90%,#fff 10%)}
  .btn.danger{background:var(--danger);border:none;color:#fff}
  .btn.danger:hover{background:var(--danger-hover)}
  .btn.small{padding:9px 14px;border-radius:8px;font-size:14px;font-weight:600}
  .btn[disabled]{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none;background-color:#e9e9eb !important;color:var(--muted) !important;}
  .kpi{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .kpi .chip{padding:12px 18px;border-radius:10px;font-size:14px;color:var(--muted);display:flex;align-items:center;gap:8px;background:var(--panel); border:1px solid var(--border);}
  .kpi-main-chip strong{font-size:1.6em;font-weight:700;color:var(--text);margin-left:6px;font-variant-numeric:tabular-nums}
  .auth-chip .btn{white-space:nowrap}
  .auth-status{display:none;font-size:12px;color:var(--muted);font-weight:600}
  .auth-chip.logged-in .auth-status{display:inline-flex;align-items:center;gap:8px; color:var(--success)}
  .auth-chip.logged-in .auth-status .user-avatar { width: 24px; height: 24px; border-radius: 999px; background-size: cover; background-position: center; background-color: var(--ring-bg); }
  .auth-chip.logged-in .btn-login{display:none}
  .auth-chip:not(.logged-in) .btn-logout {display: none;}
  .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:5px 10px;border-radius:999px;background-color:#f0f0f2;border:1px solid transparent;color:var(--muted)}
  .tasks{display:flex;flex-direction:column;gap:12px}
  .task{display:grid;grid-template-columns:auto 1fr auto auto;gap:12px;align-items:center;padding:16px;border:1px solid var(--border);border-radius:10px;background:var(--panel-2);transition:all .2s ease}
  .task:hover{border-color:color-mix(in srgb,var(--accent) 40%,var(--border));background:#fafafd}
  .task.selected{border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in srgb,var(--accent) 25%,transparent);background:color-mix(in srgb,var(--accent) 10%,var(--panel))}
  .task-title { font-weight: 600; font-size: 15px; }
  .task-meta { font-size: 12px; margin-top: 4px; color: var(--muted); }
  .task-meta b { font-weight: 600; color: var(--text); }
  .task-actions-footer { display: flex; gap: 10px; margin-top: 16px; }
  .task .reward-tag{margin-top:8px;display:inline-flex;align-items:center;gap:4px;font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid transparent;background:color-mix(in srgb,var(--accent) 15%,transparent);color:var(--accent)}
  .compose-grid{display:grid;grid-template-columns:minmax(0,1fr) 160px minmax(0,220px);gap:14px;align-items:end;margin-bottom:20px}
  .compose-grid .field{display:flex;flex-direction:column;gap:6px}
  .compose-grid label{font-size:11px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);font-weight:600}
  .compose-grid .actions{display:flex;gap:8px}
  .compose-grid .actions .btn{flex:1}
  .pane{border:1px solid var(--border);border-radius:10px;padding:14px; background:#fdfdfd;}
  .timer{display:grid;grid-template-rows:auto 1fr auto;min-height:520px}
  .timer .bd{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px}
  .timer-label{font-size:12px;color:var(--muted);text-transform:uppercase;font-weight:600;letter-spacing:.08em}
  .centerFlip{pointer-events:none}
  .timer-kpis{display:flex;gap:14px;flex-wrap:wrap;justify-content:center;margin-top:24px}
  .timer-kpis .pill{border:1px solid var(--border);padding:10px 16px;border-radius:999px;color:var(--muted);font-size:14px;background:var(--panel-2)}
  .timer-kpis .pill strong { color: var(--text); font-weight: 600; margin-left: 6px; }
  .timer-kpis .pill.warn{border-color:var(--danger);color:var(--danger);background:color-mix(in srgb, var(--danger) 10%, transparent)}
  .flip{display:inline-flex;gap:6px;align-items:flex-end}
  .flip .col{position:relative;width:24px;height:32px;overflow:hidden;border-radius:6px;background:#f0f0f2;border:1px solid var(--border)}
  .flip.large .col{width:36px;height:48px;border-radius:8px}
  .flip.small .col{width:18px;height:24px}
  .flip .digits{position:absolute;left:0;top:0;width:100%;display:flex;flex-direction:column;align-items:center;transition:transform .22s cubic-bezier(.2,.6,.2,1)}
  .flip .digit{width:100%;height:32px;display:grid;place-items:center;font-variant-numeric:tabular-nums;font-size:20px;font-weight:800;color:var(--text)}
  .flip.large .digit{height:48px;font-size:32px}
  .flip.small .digit{height:24px;font-size:14px}
  .flip .sep{width:6px;text-align:center;color:var(--muted);font-weight:800;user-select:none}
  .flip.large .sep{width:10px}
  .modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:110;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
  .modal{width:min(640px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);color:var(--text)}
  .modal .mh{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
  .modal .mb{padding:24px}
  .result-bar{margin-top:10px;padding:12px 14px;border-radius:8px;border:1px solid transparent;}
  .result-ok{border-color:var(--success);background-color:color-mix(in srgb,var(--success) 10%,transparent)}
  .result-warn{border-color:var(--warning);background-color:color-mix(in srgb,var(--warning) 10%,transparent)}
  .result-err{border-color:var(--danger);background-color:color-mix(in srgb,var(--danger) 10%,transparent)}
  .badge{display:inline-block;margin-right:8px;margin-bottom:8px;padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fdfdfd;font-size:13px}
  .choice{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
  .choice .opt{flex:1;min-width:120px;text-align:center;border:1px solid var(--border);border-radius:10px;padding:12px 14px;background:#fdfdfd;cursor:pointer;transition:all .2s ease}
  .choice .opt:hover{border-color:var(--accent);background:color-mix(in srgb,var(--accent) 10%,transparent)}
  .loots{display:inline-flex;gap:8px;align-items:center;flex-wrap:wrap}
  .loot{padding:4px 8px;border:1px solid var(--border);border-radius:8px;font-size:12px; background:var(--panel);}
  details.workshop{margin-top:12px;border:1px solid var(--border);border-radius:10px;padding:12px;background:#fafafd;transition:background .2s ease}
  details[open]{background:#fdfdfd}
  summary{cursor:pointer;font-weight:600}
  .workshop-body{margin-top:12px;display:grid;gap:14px}
  .workshop-section{border:1px solid var(--border);border-radius:10px;padding:12px}
  .badge-card{border:1px solid var(--border);border-radius:10px;padding:12px;display:grid;gap:6px;background:var(--panel-2)}
  .loadout-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
  .loadout-slot{border:1px solid var(--border);border-radius:10px;padding:12px;display:grid;gap:8px;background:#fdfdfd}
  .cooldown-label{font-size:12px;color:var(--muted)}
  .badge-tier-rare{color:#007aff}
  .badge-tier-epic{color:#af52de}
  .badge-tier-legend{color:#ff9500}
  .toast-container{position:fixed;top:calc(16px + env(safe-area-inset-top));right:16px;display:flex;flex-direction:column;gap:10px;z-index:120;pointer-events:none}
  .toast{background:rgba(250,250,250,.9);border:1px solid var(--border);border-left:4px solid var(--accent);padding:12px 16px;border-radius:8px;color:var(--text);min-width:240px;max-width:320px;box-shadow:var(--shadow);opacity:0;transform:translateY(14px);transition:opacity .3s ease,transform .3s ease;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
  .toast.show{opacity:1;transform:translateY(0)}
  .funshop-list{display:grid;gap:12px}
  .funshop-item{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fdfdfd;display:grid;gap:8px}
  .funshop-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .funshop-need{display:inline-flex;gap:6px;align-items:center;background:#f0f0f2;border:1px solid var(--border);border-radius:999px;padding:4px 8px;color:var(--muted);font-size:12px}
  .mini-timer{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:8px;padding:4px 8px;background:#fdfdfd;font-size:12px;color:var(--muted)}
  .funshop-muted{color:var(--muted);font-size:12px}
  .funshop-grid-2{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  .fb-line{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .fb-chip{display:inline-flex;align-items:center;gap:4px;font-size:12px;border-radius:999px;padding:4px 9px;border:1px solid transparent;background:#f0f0f2}
  .fb-rare{border-color:#007aff33;color:#007aff}
  .fb-epic{border-color:#af52de33;color:#af52de}
  .fb-legend{border-color:#ff950033;color:#ff9500}
  .fb-util{border-color:#a0a0a533;color:#a0a0a5}
  .fb-bad{border-color:#ff3b3033;color:#ff3b30}
  .modal .note{font-size:13px;color:var(--muted);line-height:1.6}
  
  pre.note { background: #f5f5f7 !important; border-color: var(--border) !important; color: #555; }
  textarea { background: #fafafa !important; color: var(--text) !important; border-color: var(--border) !important; }

  .completion-animation-container{position:fixed;inset:0;pointer-events:none;z-index:9999;overflow:hidden}
  .completion-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) scale(.5);font-size:clamp(3rem,12vw,5rem);font-weight:900;color:var(--primary);text-shadow:0 0 20px color-mix(in srgb, var(--primary) 30%, transparent);opacity:0;white-space:nowrap;animation:complete-anim 1.8s cubic-bezier(.18,.89,.32,1.28) forwards}
  @keyframes complete-anim{0%{opacity:0;transform:translate(-50%,-50%) scale(.5) rotate(-15deg)}40%,60%{opacity:1;transform:translate(-50%,-50%) scale(1.1) rotate(5deg)}100%{opacity:0;transform:translate(-50%,-50%) scale(.8) rotate(-10deg) translateY(40px)}}
  .confetti{position:absolute;width:8px;height:16px;opacity:0;animation:confetti-fall 2.5s ease-out forwards}
  @keyframes confetti-fall{0%{opacity:1;transform:translateY(-10vh) rotate(0deg)}100%{opacity:0;transform:translateY(110vh) rotate(720deg)}}

  .bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;height:calc(55px + env(safe-area-inset-bottom));padding-bottom:env(safe-area-inset-bottom);background:rgba(249,249,249,.9);backdrop-filter:saturate(180%) blur(20px);-webkit-backdrop-filter:saturate(180%) blur(20px);border-top:1px solid #c7c7c9;z-index:100}
  .bottom-nav .tab-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;color:var(--muted);background:none;border:none;font-size:10px;cursor:pointer;transition:color .2s ease;padding-top:4px}
  .bottom-nav .tab-btn svg{width:24px;height:24px;stroke-width:2}
  .bottom-nav .tab-btn.active{color:var(--accent)}
  
  #devBtnWrapper { display: none; }
  
  #dailyList { display:flex; flex-direction:column; gap:12px; }
  .daily-task-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 12px 14px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--panel-2);
  }
  .daily-task-info { flex: 1; min-width: 0; }
  .daily-task-label { font-weight: 500; font-size: 14px; color: var(--text); }
  .daily-task-progress { font-size: 12px; margin-top: 4px; }

  .dev-input { width: 100%; }
  #devBody label.muted { font-size: 11px; margin-bottom: 4px; display: block; text-transform: none; letter-spacing: 0; }
  .kpi-row { display: contents; }
  .code-block-wrapper { position: relative; }
  .code-block-wrapper .btn {
    position: absolute;
    top: 8px;
    right: 8px;
  }

  @keyframes modal-slide-up{from{transform:translateY(100%)}to{transform:translateY(0)}}

  .desktop-tabs { display: none; }
  
  #modeSwitchWrapper, #helpBtnWrapper, #devBtnWrapper, #authChipWrapper {
    padding: 0;
  }
  #modeSwitchWrapper .btn, #helpBtnWrapper .btn, #devBtnWrapper .btn, #authChipWrapper .btn {
    padding: 12px 18px;
    font-size: 14px;
  }
  
  /* "You" Page Styles */
  .you-pane-workspace { display: flex; gap: 24px; }
  .you-right-col { flex: 1; min-width: 0; }
  .char-card { display: flex; flex-direction: column; gap: 16px; }
  .avatar-container { display: flex; align-items: center; gap: 20px; }
  .avatar-uploader {
    width: 120px; height: 120px;
    flex-shrink: 0;
    border-radius: 12px;
    border: 1px solid var(--border);
    background-color: var(--ring-bg);
    background-size: cover;
    background-position: center;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    font-size: 12px;
    text-align: center;
    transition: all .2s ease;
  }
  .avatar-uploader:hover { border-color: var(--primary); background-color: #e0e0e0; }
  .char-info-grid { display: grid; gap: 12px; flex: 1; }
  .char-info-grid .field { display: flex; flex-direction: column; gap: 4px; }
  .char-info-grid label { font-size: 11px; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); }
  .char-info-grid input { padding: 10px 12px; font-size: 14px; }

  .char-status-card, .char-buffs-card {
    border: 1px solid var(--border);
    border-radius: 10px;
    background: var(--panel-2);
    padding: 16px;
  }
  .char-status-card h3, .char-buffs-card h3 { margin: 0 0 10px; font-size: 14px; }
  .char-status-tag { display: inline-block; padding: 4px 10px; background: var(--ring-bg); border-radius: 8px; font-size: 13px; font-weight: 600; }
  .char-buffs-list { display: flex; flex-direction: column; gap: 6px; }
  .char-buff-item { font-size: 13px; }

  /* New Block EXP Bar Styles */
  .exp-bar-container {
    margin-top: 14px;
    user-select: none;
    font-family: ui-monospace, monospace;
  }
  .exp-bar-header {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    color: #9aa0b0;
    margin-bottom: 4px;
  }
  .exp-bar {
    position: relative;
    width: 100%;
    height: 10px;
    background-color: #1e2433;
    border-radius: 6px;
    overflow: hidden;
  }
  .exp-bar-fill {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    background-color: #5f80f8;
    border-radius: 6px;
    width: 0%;
    transition: width 0.15s linear;
    box-shadow: inset 0 -1px 0 rgba(255,255,255,0.15);
  }
  .exp-bar-info {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #9aa0b0;
    margin-top: 4px;
  }
  .exp-gap {
    opacity: 0.8;
  }

  .loading-overlay {
    position: fixed; inset: 0;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9998;
    font-weight: 600;
    color: var(--muted);
  }
  
  /* Desktop and Tablet Styles */
  @media (min-width: 768px) {
    .card .desktop-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 24px 0;
      border-bottom: 1px solid var(--border);
    }
    .desktop-tab {
      padding: 10px 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      color: var(--muted);
      border-bottom: 3px solid transparent;
      transition: all .2s ease;
    }
    .desktop-tab:hover { color: var(--text); }
    .desktop-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    .workspace {
      align-items: stretch;
    }
    .column > .card {
      flex-grow: 1;
    }
    .bottom-nav {
      display: none !important;
    }
    .tab-pane > .hd {
        display: none;
    }
  }
  
  /* Tablet: Single Column Layout */
  @media (max-width: 1100px) {
    .workspace{grid-template-columns:1fr}
  }

  /* Mobile Styles */
  @media (max-width: 767px) or (max-height: 500px){
    :root{--panel:#ffffff;--panel-2:#fdfdfd;--border:#e5e5e5;--bg:#f0f0f2}
    body{-webkit-tap-highlight-color:transparent; overscroll-behavior-y: contain;}
    .app{padding:env(safe-area-inset-top) 16px calc(60px + env(safe-area-inset-bottom));margin:0 auto}
    .workspace{grid-template-columns:1fr;gap:0; margin-top: 16px;}
    .column { gap: 16px; }
    header{flex-direction:column;align-items:center;gap:16px;padding:16px 0 0; margin-bottom: 0;}
    h1{font-size:28px;font-weight:800}
    h3 {font-size: 16px;}
    .kpi{width:100%;gap:12px;flex-direction:column;align-items:stretch}
    .kpi .chip{width:100%;justify-content:space-between;border-radius:10px;background:var(--panel);padding:14px;font-size:18px}
    #helpBtnWrapper { display: none; }
    #authChipWrapper {
      order: 10;
    }
    .desktop-tabs { display: none; }
    .kpi-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      width: 100%;
      border-radius: 10px;
      background: var(--panel);
      padding: 14px;
      border: 1px solid var(--border);
    }
    .kpi-row > .chip {
      width: auto;
      padding: 0;
      border: none;
      background: none;
      box-shadow: none;
    }
    .desktop-only-kpi { display: none; }
    .mobile-header-card {
        display: flex;
        gap: 12px;
        align-items: center;
        width: 100%;
    }
    .mobile-char-avatar {
        flex-shrink: 0;
        flex-basis: 30%;
        max-width: 80px;
        aspect-ratio: 1 / 1;
        border-radius: 10px;
        background-color: var(--ring-bg);
        background-size: cover;
        background-position: center;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        color: var(--muted);
    }
    .mobile-char-details {
        flex: 1;
        min-width: 0;
    }
    .mobile-char-status {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }
    .mobile-char-status .char-info {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        padding: 0 2px;
    }
    .mobile-char-status .char-name {
        font-weight: 700;
        font-size: 18px;
        color: var(--text);
    }
    .mobile-char-status .char-title {
        font-size: 12px;
        font-weight: 500;
        color: var(--muted);
    }
    .mobile-char-status .exp-bar-container {
        margin-top: 0;
    }
    .mobile-char-status .exp-bar-header {
        font-size: 12px;
        margin-bottom: 4px;
    }
    .mobile-char-status .exp-bar {
        height: 8px;
    }
    .mobile-char-status .exp-bar-header .exp-buffs {
      font-weight: 600;
      color: var(--accent);
      font-size: 11px;
    }
    #authChipWrapper {
      padding: 0;
      border: none;
      background: transparent;
    }
    #authChipWrapper .btn {
      width: 100%;
    }
    .auth-chip{gap:8px}
    .auth-chip .btn-login{flex:1}
    .auth-chip .auth-status{justify-content:flex-start}
    .bottom-nav{display:flex}
    .column-main.mobile-hidden, .column-side.mobile-hidden {display:none}
    .card{border-radius:12px;border:1px solid var(--border);background:var(--panel);box-shadow:none;}
    .card .hd { padding: 18px 20px; }
    .card .hd h2 { font-size: 22px; }
    .card .bd{padding:20px}
    .row{flex-direction:column;align-items:stretch}
    .row > *{width:100%}
    .tasks{gap:12px}
    .task-title { font-size: 16px; }
    .task-actions-footer { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 16px; }
    .compose-grid{grid-template-columns:1fr;gap:16px}
    .compose-grid .actions{flex-direction:column}
    .compose-grid .field{gap:8px}
    .compose-grid label{font-size:12px;font-weight:600}
    input,select{border-radius:8px;background:var(--bg);border-color:var(--border);padding:14px;font-size:16px}
    .btn{border-radius:10px;font-size:16px;padding:14px}
    .btn.small{border-radius:8px;font-size:13px;padding:10px}
    .task{display:flex;flex-direction:column;align-items:stretch;gap:10px;border-radius:10px;padding:14px;background:#fdfdfd}
    .task .controls{display:flex;gap:8px}
    .task .controls .btn{flex:1}
    .task > div:last-child .btn{width:100%}
    #inventoryActionsModule { display: none; }
    .loadout-grid { grid-template-columns: 1fr; }
    .loadout-slot { 
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
    }
    .loadout-slot .muted { flex: 1; }
    .loadout-slot .btn { flex-shrink: 0; white-space: nowrap; }
    .section-2col{grid-template-columns:1fr;gap:12px}
    .timer{min-height:440px}
    .timer .bd{padding:18px}
    .timer-label { font-size: 13px; }
    .timer-kpis{gap:10px;flex-direction:column;align-items:stretch;width:100%;margin-top:24px}
    .timer-kpis .pill{width:100%;justify-content:space-between;display:flex;border-radius:10px;padding:12px;font-size:15px}
    .toast-container{top:calc(16px + env(safe-area-inset-top));right:16px;left:16px;width:auto}
    .modal-mask{align-items:flex-end;justify-content:center}
    .modal-mask[style*="display: flex"] .modal{animation:modal-slide-up .4s cubic-bezier(.16,1,.3,1)}
    .modal{width:100%;max-height:90vh;overflow-y:auto;border-radius:16px 16px 0 0;border:none;background:var(--panel);box-shadow:0 -10px 40px rgba(0,0,0,.2);padding-bottom:env(safe-area-inset-bottom)}
    .modal .mb{padding:16px}
    .modal .mh::before{content:'';position:absolute;top:8px;left:50%;transform:translateX(-50%);width:40px;height:5px;background:#cccccc;border-radius:99px}
    .modal .mh{padding-top:24px;border:none}
    #dailyTasksSection { margin-top: 16px; }
    #dailyTasksSection h3, #dailyTasksSection > small { display: none; }
    .daily-task-label { font-size: 15px; }
    #modeSwitchWrapper { padding: 0; border: none; background: transparent; }
    #modeSwitchBtn { width: 100%; }
    
    .you-pane-workspace { flex-direction: column; gap: 16px; }
    .avatar-container { flex-direction: column; align-items: stretch; text-align: center; }
    .avatar-uploader {
      width: 100%;
      height: auto;
      aspect-ratio: 1/1;
    }
    .you-page-actions .btn {
      width: 100%;
    }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>豪情在天</h1>
    <div class="kpi">
      <div class="kpi-row desktop-only-kpi">
        <span class="chip" id="totalValorChip">总豪情值：<strong id="kpiTotalValue">0</strong></span>
        <span class="chip">累计用时：<strong id="kpiTime">0:00:00</strong></span>
      </div>
      <div class="kpi-row" id="mobileHeaderStatus"></div>
      <span class="chip" id="modeSwitchWrapper"><button class="btn" id="modeSwitchBtn">专注模式</button></span>
      <span class="chip" id="helpBtnWrapper"><button class="btn" id="btnHelp">帮助 ❓</button></span>
      <span class="chip auth-chip" id="authChipWrapper">
          <button class="btn btn-login" id="btnLogin">用 Google 登录</button>
          <span class="auth-status">
              <span class="user-avatar" id="userAvatar"></span>
              <span id="authStatusText">已登录</span>
          </span>
          <button class="btn small btn-logout" id="btnLogout">登出</button>
      </span>
      <span class="chip" id="devBtnWrapper"><button class="btn" id="btnDev">调试 ⚙️</button></span>
    </div>
  </header>

  <div class="workspace">
    <div class="column column-main" id="mainColumn">
      <section class="card">
        <div class="desktop-tabs">
            <button class="desktop-tab active" data-desktop-target="tasks-pane" data-sound-id="sfxNavTasks">任务</button>
            <button class="desktop-tab" data-desktop-target="backpack-pane" data-sound-id="sfxNavBackpack">背包</button>
            <button class="desktop-tab" data-desktop-target="club-pane" data-sound-id="sfxNavClub">俱乐部</button>
            <button class="desktop-tab" data-desktop-target="you-pane" data-sound-id="sfxNavYou">你</button>
        </div>

        <div class="tab-pane" id="tasks-pane">
            <div class="hd">
              <h2>任务清单</h2>
              <span class="muted">创建 → 选择 → 开始</span>
            </div>
            <div class="bd">
              <div class="compose-grid">
                <div class="field">
                  <label for="taskTitle">任务标题</label>
                  <input id="taskTitle" type="text" placeholder="任务标题（如：论文引言改写）" />
                </div>
                <div class="field" style="max-width:160px">
                  <label for="taskDiff">难度</label>
                  <select id="taskDiff">
                    <option value="1">难度 1 · 轻松</option>
                    <option value="2">难度 2</option>
                    <option value="3" selected>难度 3 · 标准</option>
                    <option value="4">难度 4</option>
                    <option value="5">难度 5 · 硬仗</option>
                  </select>
                </div>
                <div class="field actions">
                  <button class="btn primary" id="btnAdd">添加任务</button>
                  <button class="btn" id="btnClearAll">清空数据</button>
                </div>
              </div>
              <div class="tasks" id="taskList"></div>
              <div class="muted" id="emptyTask" style="display:none;padding:18px;text-align:center">暂无任务，先在上方添加一个。</div>
              
              <div id="dailyTasksSection" style="margin-top: 24px;">
                 <h3 style="margin:0 0 12px;font-size:14px;border-top:1px solid var(--border);padding-top:16px;">每日任务</h3>
                 <div id="dailyList"></div>
                 <small class="muted" style="display: block; margin-top: 10px;font-size:12px;">每日首刷免费，可在下方按钮区快速刷新或导入任务。</small>
              </div>

              <div class="task-actions-footer">
                <button class="btn small" id="btnDailyRefresh">刷新任务</button>
                <button class="btn small" id="btnTaskLibrary">任务库</button>
                <button class="btn small" id="btnTodayDone">今日已完成</button>
              </div>
            </div>
        </div>

        <div class="tab-pane" id="backpack-pane" style="display: none;">
            <div class="hd">
              <h2>背包</h2>
              <span class="muted">库存与工坊</span>
            </div>
            <div class="bd" style="display: flex; flex-direction: column; gap: 16px;">
               <div class="pane">
                <h3>库存快照</h3>
                <div class="badge-row" id="invRow"></div>
               </div>
               <div class="pane">
                <h3>徽章工坊</h3>
                <div class="workshop-body" id="badgeWorkshopBody"></div>
               </div>
            </div>
        </div>

        <div class="tab-pane" id="club-pane" style="display: none;">
            <div class="hd">
              <h2>俱乐部</h2>
              <span class="muted">奖励与娱乐</span>
            </div>
            <div class="bd" style="display: flex; flex-direction: column; gap: 16px;">
                <div class="control-group">
                  <h4>幸运轮</h4>
                  <div style="display:grid;place-items:center;gap:10px">
                    <div id="prizeTicker" style="min-height:48px;font-size:20px;font-weight:800;letter-spacing:1px;padding:12px 16px;border:1px dashed var(--border);border-radius:8px;background:#fdfdfd;width:100%;text-align:center">
                      点击“开始抽奖”
                    </div>
                    <div class="muted" style="font-size:12px">消耗抽卡券×1，名称将快速跳动，停止即为结果</div>
                  </div>
                  <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
                    <button class="btn primary" id="btnSpin">开始抽奖</button>
                  </div>
                  <div id="wheelResult" class="wheel-result muted" aria-live="polite" style="text-align:center;margin-top:6px"></div>
                </div>
                <div class="control-group">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                      <h4 style="margin:0">娱乐活动</h4>
                      <button class="btn small" id="btnFunshopEdit">调试/导入</button>
                    </div>
                    <div class="note" style="margin-bottom:8px;font-size:12px">
                      点“兑换”将检验并消耗所需徽章数量；若配置了磨损，将累计到对应徽章的磨损池，达到上限会按倍数销毁徽章。
                    </div>
                    <div id="funshopList" class="funshop-list"></div>
                </div>
            </div>
        </div>

        <div class="tab-pane" id="you-pane" style="display: none;">
            <div class="hd">
              <h2>你</h2>
              <span class="muted">角色状态</span>
            </div>
            <div class="bd">
                <div class="you-pane-workspace">
                    <div class="you-right-col">
                        <div class="char-card">
                            <div class="avatar-container">
                                <div class="avatar-uploader" id="avatarUploader">点击<br>上传头像</div>
                                <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                            </div>
                            
                            <div class="exp-bar-container">
                              <div class="exp-bar-header">
                                <span class="exp-level">Lv.<span id="expLevelNow">1</span></span>
                                <span class="exp-level exp-next">Lv.<span id="expLevelNext">2</span></span>
                              </div>
                              <div class="exp-bar">
                                <div class="exp-bar-fill" id="expBarFill"></div>
                              </div>
                              <div class="exp-bar-info">
                                <span id="expValueText">0 / 1000</span>
                                <span class="exp-gap">距下级：1000 豪情值</span>
                              </div>
                            </div>
                            
                            <div class="char-info-grid">
                                <div class="field">
                                    <label for="charNameInput">名称</label>
                                    <input type="text" id="charNameInput" placeholder="输入你的名称">
                                </div>
                                 <div class="field">
                                    <label for="charTitleInput">称号</label>
                                    <input type="text" id="charTitleInput" placeholder="输入你的称号">
                                </div>
                            </div>

                            <div class="char-status-card">
                                <h3>状态</h3>
                                <div class="row" style="gap: 16px; align-items: center;">
                                    <span class="char-status-tag" id="charStatusTag">离线</span>
                                    <div class="muted" style="font-size: 13px;">等级：<b id="charLevelText">Lv. 1</b></div>
                                    <div class="muted" style="font-size: 13px;">总豪情值：<b id="charTotalHQText">0 HQ</b></div>
                                </div>
                            </div>
                            <div class="char-buffs-card">
                                <h3>Buff 与持续时间</h3>
                                <div class="char-buffs-list" id="charBuffsList">
                                    <div class="char-buff-item muted">无</div>
                                </div>
                            </div>
                        </div>
                        <div class="you-page-actions" style="margin-top: 24px;">
                            <button class="btn" id="youPageHelpBtn">帮助</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </section>
    </div>

    <div class="column column-side" id="timerCard">
      <section class="card timer">
        <div class="hd">
          <h2>计时与豪情值</h2>
          <span class="muted" id="activeHint">未选择任务</span>
        </div>
        <div class="bd" style="position:relative">
          <div style="display:flex; flex-direction:column; align-items:center; gap: 12px;">
            <div class="timer-label">本次豪情值</div>
            <div class="centerFlip"><div id="sessionFlip" class="flip large"></div></div>
            <div class="timer-label">速率：<b id="rateText">0</b> / 秒</div>
          </div>
          <div class="timer-kpis">
            <div class="pill">当前任务累计豪情值：<strong id="taskTotal">0</strong></div>
            <div class="pill">本次用时：<strong id="sessionTime">0:00:00</strong></div>
            <div class="pill">任务总用时：<strong id="taskTime">0:00:00</strong></div>
            <div class="pill warn" id="pauseIndicator" style="display:none">已暂停：<strong id="pauseTime">0:00</strong></div>
          </div>
        </div>
        <div class="bd" style="padding-top:0">
          <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center">
            <button class="btn accent" id="btnStart"  aria-label="开始" disabled>开始</button>
            <button class="btn"         id="btnPause"  aria-label="暂停" disabled>暂停</button>
            <button class="btn danger"  id="btnStop"   aria-label="结束"  disabled>结束</button>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- 娱乐兑换所 · 调试器 -->
<div class="modal-mask" id="funshopEditMask" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mh">
      <h3>俱乐部 · 调试导入</h3>
      <button class="btn small" id="btnCloseFunshopEdit">完成</button>
    </div>
    <div class="mb">
      <div class="note" style="margin-bottom:6px">一行一个娱乐活动，格式：</div>
      <div class="code-block-wrapper">
        <pre class="note" id="funshopFormatExample">
名称|时长秒|需求: badge*数量[,badge*数量...]|磨损: badge*磨损[,badge*磨损...]|时段: HH:MM-HH:MM
示例：
放松呼吸训练|300|需求: rare_token*1|磨损: rare_token*5|
豪情轮盘挑战|180|需求: epic_token*1|磨损: epic_token*8|时段: 19:00-23:00
街机小游园|120|需求: rare_token*1|磨损: rare_token*3,ticket*1|
        </pre>
        <button class="btn small" id="btnCopyFunshopFormat">复制</button>
      </div>
      <textarea id="funshopInput" style="width:100%;height:200px;border-radius:10px;padding:10px;font-family:monospace; margin-top: 8px;" placeholder="在此粘贴/编辑娱乐活动清单"></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn" id="btnFunshopImport">导入覆盖</button>
      </div>
    </div>
  </div>
</div>

<!-- 任务库模态框 -->
<div class="modal-mask" id="taskLibraryMask" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mh">
      <h3>任务库</h3>
      <button class="btn small" id="btnCloseTaskLibrary">关闭</button>
    </div>
    <div class="mb">
      <p style="font-size: 13px; color: var(--muted); margin: 0 0 10px;">
        任务库语法（每行：<strong>标题|难度|奖励类型|数量</strong>，奖励可选）：<br>
        <code style="background: var(--ring-bg); padding: 2px 4px; border-radius: 4px;">论文引言改写|3|ticket|1</code><br>
        <code style="background: var(--ring-bg); padding: 2px 4px; border-radius: 4px;">代码重构|4|rare_gem|2</code><br>
        <code style="background: var(--ring-bg); padding: 2px 4px; border-radius: 4px;">文档撰写|2</code><br>
        可选奖励：hq（豪情值）、ticket（抽卡券）、freeze、rare_gem、epic_gem、rare_token、epic_token、legend_token
      </p>
      <textarea id="taskLibraryInput" placeholder="在此粘贴你的任务列表，每行格式：标题|难度|奖励|数量（奖励可省略）" style="width: 100%; height: 200px; border-radius: 10px; padding: 10px; resize: vertical; font-family: monospace;"></textarea>
      <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 10px;">
        <button class="btn" id="btnImportTasks">导入任务</button>
      </div>
    </div>
  </div>
</div>

<!-- 奖励弹窗 -->
<div class="modal-mask" id="rewardMask" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mh">
      <h3>奖励阶段</h3>
      <button class="btn small" id="btnCloseReward">关闭</button>
    </div>
    <div class="mb" id="rewardBody"></div>
  </div>
</div>

<!-- 今日已完成 -->
<div class="modal-mask" id="todayDoneMask" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mh">
      <h3>今日已完成</h3>
      <button class="btn small" id="btnCloseTodayDone">关闭</button>
    </div>
    <div class="mb" id="todayDoneBody" style="display:grid;gap:8px"></div>
  </div>
</div>

<!-- 帮助弹窗 -->
<div class="modal-mask" id="helpMask">
  <div class="modal">
    <div class="mh"><h3>怎么玩（超简）</h3><button class="btn small" id="btnCloseHelp">关闭</button></div>
    <div class="mb" id="helpContent" style="line-height:1.7">
      ① 新建任务并选择 → 点<b>继续</b>开始计时。<br/>
      ② 难度越高，豪情值/秒越多（可在<b>调试</b>里自定义）。<br/>
      ③ 计时中：只亮<b>暂停/结束</b>；暂停后：只亮<b>开始/结束</b>。<br/>
      ④ 结束进入<b>奖励</b>；开<b>街机</b>可押注奖金。<br/>
      ⑤ 每日任务/幸运轮产出<b>抽卡券、冻结卡、碎片</b>。
      <div style="border-top: 1px solid var(--border); margin-top: 20px; padding-top: 20px;">
        <div style="margin-top: 16px; text-align: center;">
            <button class="btn" id="btnToggleSound">音效：开启</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 调试后门 -->
<div class="modal-mask" id="devMask">
  <div class="modal">
    <div class="mh"><h3>调试面板（后门）</h3><button class="btn small" id="btnCloseDev">关闭</button></div>
    <div class="mb" id="devBody" style="display: flex; flex-direction: column; gap: 16px;">
      <div class="control-group">
        <h4>速率配置</h4>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;">
            <div><label class="muted">难度1速率</label><input class="dev-input" type="number" id="rate1" min="0" step="0.1"></div>
            <div><label class="muted">难度2速率</label><input class="dev-input" type="number" id="rate2" min="0" step="0.1"></div>
            <div><label class="muted">难度3速率</label><input class="dev-input" type="number" id="rate3" min="0" step="0.1"></div>
            <div><label class="muted">难度4速率</label><input class="dev-input" type="number" id="rate4" min="0" step="0.1"></div>
            <div><label class="muted">难度5速率</label><input class="dev-input" type="number" id="rate5" min="0" step="0.1"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;">
            <button class="btn primary" id="btnSaveRates">保存速率</button>
            <button class="btn" id="btnResetRates">恢复默认</button>
        </div>
      </div>
      <div class="control-group">
        <h4>奖励阶段配置</h4>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;">
            <div><label class="muted">基础胜率</label><input class="dev-input" type="number" id="devRewardBaseChance" min="0" max="1" step="0.01"></div>
            <div><label class="muted">押注系数</label><input class="dev-input" type="number" id="devRewardBetCoeff" min="0" step="0.01"></div>
            <div><label class="muted">最高胜率</label><input class="dev-input" type="number" id="devRewardMaxChance" min="0" max="1" step="0.01"></div>
            <div><label class="muted">怜悯值增量</label><input class="dev-input" type="number" id="devRewardPityInc" min="0" step="0.001"></div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;">
            <button class="btn primary" id="btnSaveRewardParams">保存赔率</button>
            <button class="btn" id="btnResetRewardParams">恢复默认</button>
        </div>
      </div>
      <div class="control-group">
          <h4>资源编辑器</h4>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px 8px;">
              <div><label class="muted">总豪情值</label><input class="dev-input" type="number" id="devTotalHQ"></div>
              <div><label class="muted">抽卡券</label><input class="dev-input" type="number" id="devTickets"></div>
              <div><label class="muted">冻结卡</label><input class="dev-input" type="number" id="devFreeze"></div>
              <div><label class="muted">稀有碎片</label><input class="dev-input" type="number" id="devRareGem"></div>
              <div><label class="muted">史诗碎片</label><input class="dev-input" type="number" id="devEpicGem"></div>
              <div><label class="muted">稀有徽章</label><input class="dev-input" type="number" id="devRareToken"></div>
              <div><label class="muted">史诗徽章</label><input class="dev-input" type="number" id="devEpicToken"></div>
              <div><label class="muted">传说徽章</label><input class="dev-input" type="number" id="devLegendToken"></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px;">
              <button class="btn primary" id="btnSaveResources">保存资源</button>
          </div>
      </div>
      <div class="control-group">
          <h4>高级操作</h4>
          <div class="dock-buttons">
               <button class="btn" id="btnSimulateNextDay">模拟第二天</button>
               <button class="btn" id="btnResetDaily">重置每日进度</button>
               <button class="btn danger" id="btnHardReset">硬重置应用</button>
          </div>
      </div>
      <div class="control-group">
          <h4>状态管理</h4>
          <textarea id="devStateText" style="width:100%;height:120px;border-radius:10px;padding:10px;font-family:monospace;resize:vertical;" placeholder="在此处粘贴状态JSON以导入..."></textarea>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
              <button class="btn" id="btnExportState">导出当前状态</button>
              <button class="btn primary" id="btnImportState">导入状态</button>
          </div>
      </div>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer" aria-live="polite"></div>
<div id="completion-animation-container" class="completion-animation-container"></div>
<div class="loading-overlay" id="loadingOverlay">正在加载...</div>

<!-- Sound Effects -->
<audio id="sfxNavTasks" src="assets/tasks-audio.mp3" preload="auto"></audio>
<audio id="sfxNavTimer" src="assets/timer-audio.mp3" preload="auto"></audio>
<audio id="sfxNavBackpack" src="assets/backpack-audio.mp3" preload="auto"></audio>
<audio id="sfxNavClub" src="assets/club-audio.mp3" preload="auto"></audio>
<audio id="sfxNavYou" src="assets/sfx_click.mp3" preload="auto"></audio>
<audio id="sfxAddTask" src="assets/sfx_add.mp3" preload="auto"></audio>
<audio id="sfxSelectTask" src="assets/sfx_select.mp3" preload="auto"></audio>
<audio id="sfxDeleteTask" src="assets/sfx_delete.mp3" preload="auto"></audio>
<audio id="sfxTimerStart" src="assets/sfx_timer_start.mp3" preload="auto"></audio>
<audio id="sfxTimerPause" src="assets/sfx_timer_pause.mp3" preload="auto"></audio>
<audio id="sfxTimerStop" src="assets/sfx_timer_stop.mp3" preload="auto"></audio>
<audio id="sfxModalOpen" src="assets/sfx_modal_open.mp3" preload="auto"></audio>
<audio id="sfxModalClose" src="assets/sfx_modal_close.mp3" preload="auto"></audio>
<audio id="sfxSuccess" src="assets/sfx_success.mp3" preload="auto"></audio>
<audio id="sfxWarn" src="assets/sfx_warn.mp3" preload="auto"></audio>
<audio id="sfxClick" src="assets/sfx_click.mp3" preload="auto"></audio>

<nav class="bottom-nav" aria-label="移动端视图切换">
  <button class="tab-btn active" data-mobile-target="tasks-pane" data-sound-id="sfxNavTasks">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M15 6.5l-3.5 3.5-3.5-3.5"></path><path d="M15 11.5l-3.5 3.5-3.5-3.5"></path><path d="M15 16.5l-3.5 3.5-3.5-3.5"></path><line x1="10" y1="6" x2="4" y2="6"></line><line x1="10" y1="11" x2="4" y2="11"></line><line x1="10" y1="16" x2="4" y2="16"></line></svg>
    <span>任务</span>
  </button>
  <button class="tab-btn" data-mobile-target="timerCard" data-sound-id="sfxNavTimer">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
    <span>计时</span>
  </button>
  <button class="tab-btn" data-mobile-target="you-pane" data-sound-id="sfxNavYou">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M17.6 17.6C16.4 19.2 14.4 20 12 20s-4.4-.8-5.6-2.4C7.6 16.4 8.8 15 12 15s4.4 1.4 5.6 2.6z"></path><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2z"></path></svg>
    <span>你</span>
  </button>
  <button class="tab-btn" data-mobile-target="backpack-pane" data-sound-id="sfxNavBackpack">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
    <span>背包</span>
  </button>
   <button class="tab-btn" data-mobile-target="club-pane" data-sound-id="sfxNavClub">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 12h12M12 18V6"/></svg>
    <span>俱乐部</span>
  </button>
</nav>

<script>
// PWA Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('Service worker registered.', reg))
      .catch(err => console.error('Service worker registration failed.', err));
  });
}
</script>
<script>
// ⚠️ ========================================================== ⚠️
// ⚠️  在此处粘贴你的 Firebase 项目配置!
// ⚠️  Get it from your Firebase project settings.
// ⚠️ ========================================================== ⚠️
const firebaseConfig = {
  apiKey: "AIzaSyBjcUD9nAGxg5mgTA2v7mMcfD5dcWU9nTw",
  authDomain: "haoqing-af64d.firebaseapp.com",
  projectId: "haoqing-af64d",
  storageBucket: "haoqing-af64d.firebasestorage.app",
  messagingSenderId: "1025278981441,
  appId: "1:1025278981441:web:edaf5f1aa9446246c0ddc0"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
const googleProvider = new firebase.auth.GoogleAuthProvider();

/* ========== 存储兜底层 ========== */
const localStore = (() => {
  try {
    const t = '__hq_test__';
    window.localStorage.setItem(t, '1');
    window.localStorage.removeItem(t);
    return window.localStorage;
  } catch (e) {
    const m = new Map();
    return {
      getItem: k => (m.has(k) ? m.get(k) : null),
      setItem: (k, v) => m.set(k, v),
      removeItem: k => m.delete(k)
    };
  }
})();

const readJSON = (key, fallback) => {
  try { const s = localStore.getItem(key); return s ? JSON.parse(s) : fallback; }
  catch { return fallback; }
};
const writeJSON = (key, val) => {
  try { localStore.setItem(key, JSON.stringify(val)); } catch { }
};

window.requestIdleCallback = window.requestIdleCallback || function(cb){return setTimeout(()=>cb({didTimeout:false,timeRemaining:()=>0}),200)};
window.cancelIdleCallback = window.cancelIdleCallback || function(id){clearTimeout(id)};

/* ========== 静态数据（省略无关注释） ========== */
const PRIZE_NAMES = ['特等奖','一等奖','二等奖','三等奖','四等奖','五等奖','六等奖','七等奖'];
const WHEEL_SEGMENTS = PRIZE_NAMES.map((name, i) => {
  const types = ['hq','rare','epic','freeze'];
  const colors = ['#6f87ff','#28c686','#c38bff','#ff7b92'];
  return { type: types[i % types.length], label: name, color: colors[i % colors.length] };
});

class FlipCounter{
  constructor(container,{digits=6,small=false,comma=true,large=false}={}){
    this.digits=digits;this.comma=comma;this.cellHeight=small?24:(large?48:32);
    this.root=document.createElement('div');this.root.className='flip'+(small?' small':'')+(large?' large':'');this.cols=[];
    for(let i=0;i<digits;i++){
      const col=document.createElement('div');col.className='col';
      const stack=document.createElement('div');stack.className='digits';
      for(let d=0;d<=9;d++){const cell=document.createElement('div');cell.className='digit';cell.textContent=d;stack.appendChild(cell)}
      for(const e of [0,1]){const cell=document.createElement('div');cell.className='digit';cell.textContent=e;stack.appendChild(cell)}
      col.appendChild(stack);this.root.appendChild(col);this.cols.push({stack,value:0,pos:0,wrapPos:stack.childElementCount-2});
      if(this.comma&&(digits-i)%3===1&&i!==digits-1){const sep=document.createElement('div');sep.className='sep';sep.textContent=',';this.root.appendChild(sep)}
    }
    container.innerHTML='';container.appendChild(this.root);
    const sample=this.root.querySelector('.digit'); if(sample){const rect=sample.getBoundingClientRect(); if(rect&&rect.height){this.cellHeight=rect.height;}}
    this.setValue(0,true)
  }
  _str(n){return Math.floor(n).toString().padStart(this.digits,'0').slice(-this.digits)}
  setValue(n,instant=false){
    const s=this._str(n);
    [...s].forEach((ch,i)=>{const v=ch.charCodeAt(0)-48;const c=this.cols[i];c.value=v;c.pos=v;
      if(instant)c.stack.style.transition='none';
      c.stack.style.transform=`translateY(${-c.pos*this.cellHeight}px)`;
      if(instant){void c.stack.offsetHeight;c.stack.style.transition=''}
    })
  }
  flipBy(step=1){
    for(let i=this.digits-1;i>=0;i--){
      const c=this.cols[i];const next=(c.value+step)%10;const wrap=(c.value+step)>=10;
      if(wrap){
        const wrapPos=c.wrapPos??10;
        c.pos=wrapPos;c.stack.style.transform=`translateY(${-c.pos*this.cellHeight}px)`;
        c.stack.addEventListener('transitionend',()=>{c.stack.style.transition='none';c.pos=0;c.stack.style.transform='translateY(0px)';void c.stack.offsetHeight;c.stack.style.transition=''}, {once:true});
      }else{c.pos=next;c.stack.style.transform=`translateY(${-c.pos*this.cellHeight}px)`}
      c.value=next;if(!wrap)break
    }
  }
  flipTo(n){
    const s=this._str(n);
    [...s].forEach((ch,i)=>{const v=ch.charCodeAt(0)-48;const c=this.cols[i];
      if(c.value===v) return;
      if(c.value===9&&v===0){
        const wrapPos=c.wrapPos??10;
        c.pos=wrapPos;c.stack.style.transform=`translateY(${-c.pos*this.cellHeight}px)`;
        c.stack.addEventListener('transitionend',()=>{c.stack.style.transition='none';c.pos=0;c.value=0;c.stack.style.transform='translateY(0px)';void c.stack.offsetHeight;c.stack.style.transition=''}, {once:true});
      }else{c.value=v;c.pos=v;c.stack.style.transform=`translateY(${-c.pos*this.cellHeight}px)`}
    })
  }
}

/* 经济参数/常量 */
const ECON={k:0.0009, baseFloorMinSec:180, streakStep:0.1, pauseBreakSec:90, bonusCapRatio:3, pityStep:1};
const LOOT_TABLE=[{id:'rare_gem',name:'稀有徽章碎片',rarity:'rare',p:0.22},{id:'epic_gem',name:'史诗徽章碎片',rarity:'epic',p:0.06},{id:'freeze_card',name:'冻结卡',rarity:'rare',p:0.10},{id:'ticket',name:'抽卡券',rarity:'rare',p:0.12}];
const REWARD_TYPES={
  hq:{label:'豪情值',apply:amt=>{state.agg.totalHQ=(state.agg.totalHQ||0)+amt;}},
  ticket:{label:'抽卡券',apply:amt=>{meta.tickets=(meta.tickets||0)+amt;}},
  freeze:{label:'冻结卡',apply:amt=>{meta.freeze=(meta.freeze||0)+amt;}},
  rare_gem:{label:'稀有碎片',apply:amt=>{ensureBadgeMeta();meta.badges.rare_gem=(meta.badges.rare_gem||0)+amt;}},
  epic_gem:{label:'史诗碎片',apply:amt=>{ensureBadgeMeta();meta.badges.epic_gem=(meta.badges.epic_gem||0)+amt;}},
  rare_token:{label:'稀有徽章',apply:amt=>{ensureBadgeMeta();meta.badges.rare_tokens=(meta.badges.rare_tokens||0)+amt;}},
  epic_token:{label:'史诗徽章',apply:amt=>{ensureBadgeMeta();meta.badges.epic_tokens=(meta.badges.epic_tokens||0)+amt;}},
  legend_token:{label:'传说徽章',apply:amt=>{ensureBadgeMeta();meta.badges.legendary_tokens=(meta.badges.legendary_tokens||0)+amt;}}
};
const MAX_FLIPS_PER_SECOND=8, CYCLE_SECONDS_BASE=20, CIRCUM=2*Math.PI*90;

/* ========== 主逻辑 ========== */
document.addEventListener('DOMContentLoaded', ()=>{
const LS_KEYS = {
    TASKS: "haoqing_tasks_v2",
    AGG: "haoqing_agg_v2",
    META: "haoqing_meta_v2",
    RATES: "haoqing_rates_v2",
    FUNSHOP: "haoqing_funshop_v2",
    REWARD_PARAMS: "haoqing_reward_params_v2",
    SOUND_MUTED: "haoqing_sound_muted",
};
  
  const DEFAULT_RATES={1:1,2:2,3:4,4:7,5:11};
  let RATE_BY_DIFFICULTY = (()=>{ const r=readJSON(LS_KEYS.RATES,{}); return {...DEFAULT_RATES,...r} })();
  
  const DEFAULT_REWARD_PARAMS = { baseChance: 0.4, betCoefficient: 0.25, maxChance: 0.9, pityIncrement: 0.015 };
  let REWARD_PARAMS = readJSON(LS_KEYS.REWARD_PARAMS, { ...DEFAULT_REWARD_PARAMS });
  
  const getInitialState = () => ({
    tasks: [], 
    agg: {totalHQ:0,totalSeconds:0}, 
    active: null,
    selectedTaskId: null
  });

  const getInitialMeta = () => ({
      streak:0,pity:0,arcade:false,freeze:0,badges:{},tickets:0,
      daily:{},dailyBuff:{},multDayCount:{},guardUsedToday:0,guardDay:null,nextWheelBoost:1,
      completed:{},
      funshop:{ activities:[], wearAccum:{} },
      character: { name: '', title: '', avatar: null },
      buffs: []
  });

  let state = getInitialState();
  let meta = getInitialMeta();
  let FUNSHOP = {};
  let firestoreUnsubscribe = null;

  const loadStateFromLocalStorage = () => {
    state = { 
        tasks: readJSON(LS_KEYS.TASKS, []), 
        agg: readJSON(LS_KEYS.AGG, {totalHQ:0,totalSeconds:0}), 
        active: null, // Live timer is not persisted locally to avoid sync issues
        selectedTaskId: null
    };
    meta = readJSON(LS_KEYS.META, getInitialMeta());
    FUNSHOP = readJSON(LS_KEYS.FUNSHOP, {
        items: [
          {name:'放松呼吸训练', seconds:300, need:{rare_token:1}, wear:{rare_token:5}},
          {name:'豪情轮盘挑战', seconds:180, need:{epic_token:1}, wear:{epic_token:8}, window:{start:'19:00', end:'23:00'}},
          {name:'街机小游园', seconds:120, need:{rare_token:1}, wear:{rare_token:3, ticket:1}}
        ]
    });
    ensureBadgeMeta();
  };
  
  function resetLocalState() {
      state = getInitialState();
      meta = getInitialMeta();
      loadStateFromLocalStorage(); // This will load any existing local data or defaults
      renderInitial();
  }

  const applyCloudData = (data) => {
    state.tasks = data.tasks || [];
    state.agg = data.agg || {totalHQ: 0, totalSeconds: 0};
    state.active = data.active || null; // Sync live timer state
    meta = { ...getInitialMeta(), ...data.meta };
    RATE_BY_DIFFICULTY = data.rates || DEFAULT_RATES;
    FUNSHOP = data.funshop || FUNSHOP;
    REWARD_PARAMS = data.rewardParams || DEFAULT_REWARD_PARAMS;
    ensureBadgeMeta();
    
    // Save the synced data to local storage for offline use
    writeJSON(LS_KEYS.TASKS, state.tasks);
    writeJSON(LS_KEYS.AGG, state.agg);
    writeJSON(LS_KEYS.META, meta);
    writeJSON(LS_KEYS.RATES, RATE_BY_DIFFICULTY);
    writeJSON(LS_KEYS.FUNSHOP, FUNSHOP);
    writeJSON(LS_KEYS.REWARD_PARAMS, REWARD_PARAMS);

    renderInitial();
  };

  function ensureBadgeMeta(){
    meta.badges = meta.badges || {};
    meta.badges.rare_gem = meta.badges.rare_gem || 0;
    meta.badges.epic_gem = meta.badges.epic_gem || 0;
    meta.badges.rare_tokens = meta.badges.rare_tokens || 0;
    meta.badges.epic_tokens = meta.badges.epic_tokens || 0;
    meta.badges.legendary_tokens = meta.badges.legendary_tokens || 0;
    meta.badges.owned = meta.badges.owned || {};
    meta.badges.loadout = meta.badges.loadout || {slot1:null,slot2:null,slot3:null};
    meta.badges.loadoutCooldownUntil = meta.badges.loadoutCooldownUntil || 0;
    meta.nextWheelBoost = meta.nextWheelBoost || 1;
    meta.funshop = meta.funshop || { activities:[], wearAccum:{} };
    if (!meta.character) {
        meta.character = { name: '', title: '', avatar: null };
    }
    if (!meta.buffs) { meta.buffs = []; }
  }

  const $=s=>document.querySelector(s);
  
  let isSoundMuted = readJSON(LS_KEYS.SOUND_MUTED, false);

  const sfx = {
    navTasks: $('#sfxNavTasks'), navTimer: $('#sfxNavTimer'), navBackpack: $('#sfxNavBackpack'),
    navClub: $('#sfxNavClub'), navYou: $('#sfxNavYou'), add: $('#sfxAddTask'), select: $('#sfxSelectTask'),
    delete: $('#sfxDeleteTask'), timerStart: $('#sfxTimerStart'), timerPause: $('#sfxTimerPause'),
    timerStop: $('#sfxTimerStop'), modalOpen: $('#sfxModalOpen'), modalClose: $('#sfxModalClose'),
    success: $('#sfxSuccess'), warn: $('#sfxWarn'), click: $('#sfxClick'),
  };

  function playSound(audioEl) {
    if (isSoundMuted || !audioEl) return;
    audioEl.currentTime = 0;
    const playPromise = audioEl.play();
    if (playPromise !== undefined) {
      playPromise.catch(error => { console.warn(`Audio playback for ${audioEl.id} was prevented.`); });
    }
  }

  const BADGE_META = {
    rare_token:   {label:'稀有徽章', cls:'fb-rare',   invKey:'rare_tokens'}, epic_token:   {label:'史诗徽章', cls:'fb-epic',   invKey:'epic_tokens'},
    legend_token: {label:'传说徽章', cls:'fb-legend', invKey:'legendary_tokens'}, ticket:       {label:'抽卡券',   cls:'fb-util',   invKey:null},
    freeze:       {label:'冻结卡',   cls:'fb-util',   invKey:null}
  };
  const el = {
    kpiTotalValue: $('#kpiTotalValue'), kpiTime: $('#kpiTime'), taskTitle: $('#taskTitle'), taskDiff: $('#taskDiff'),
    btnAdd: $('#btnAdd'), btnClearAll: $('#btnClearAll'), taskList: $('#taskList'), emptyTask: $('#emptyTask'), rateText: $('#rateText'),
    sessionTime: $('#sessionTime'), taskTotal: $('#taskTotal'), taskTime: $('#taskTime'), activeHint: $('#activeHint'),
    btnStart: $('#btnStart'), btnPause: $('#btnPause'), btnStop: $('#btnStop'), modeSwitchBtn: $('#modeSwitchBtn'),
    rewardMask: $('#rewardMask'), rewardBody: $('#rewardBody'), btnCloseReward: $('#btnCloseReward'), helpMask: $('#helpMask'),
    btnHelp: $('#btnHelp'), btnCloseHelp: $('#btnCloseHelp'), dailyList: $('#dailyList'), btnDailyRefresh: $('#btnDailyRefresh'),
    invRow: $('#invRow'), badgeWorkshopBody: $('#badgeWorkshopBody'), toastWrap: $('#toastContainer'), pauseIndicator: $('#pauseIndicator'),
    pauseTime: $('#pauseTime'), btnSpin: $('#btnSpin'), wheelResult: $('#wheelResult'), btnDev: $('#btnDev'), devMask: $('#devMask'),
    btnCloseDev: $('#btnCloseDev'), rate1: $('#rate1'), rate2: $('#rate2'), rate3: $('#rate3'), rate4: $('#rate4'), rate5: $('#rate5'),
    btnSaveRates: $('#btnSaveRates'), btnResetRates: $('#btnResetRates'), btnForgeFreeze: $('#btnForgeFreeze'), btnRareRefresh: $('#btnRareRefresh'),
    btnWheelBoost: $('#btnWheelBoost'), btnSpeedChip: $('#btnSpeedChip'), prizeTicker: $('#prizeTicker'), btnTaskLibrary: $('#btnTaskLibrary'),
    taskLibraryMask: $('#taskLibraryMask'), btnCloseTaskLibrary: $('#btnCloseTaskLibrary'), taskLibraryInput: $('#taskLibraryInput'),
    btnImportTasks: $('#btnImportTasks'), btnTodayDone: $('#btnTodayDone'), todayDoneMask: $('#todayDoneMask'), todayDoneBody: $('#todayDoneBody'),
    btnCloseTodayDone: $('#btnCloseTodayDone'), funshopList: $('#funshopList'), btnFunshopEdit: $('#btnFunshopEdit'),
    funshopEditMask: $('#funshopEditMask'), btnCloseFunshopEdit: $('#btnCloseFunshopEdit'), funshopInput: $('#funshopInput'),
    btnFunshopImport: $('#btnFunshopImport'), avatarUploader: $('#avatarUploader'), avatarInput: $('#avatarInput'),
    charNameInput: $('#charNameInput'), charTitleInput: $('#charTitleInput'), charStatusTag: $('#charStatusTag'),
    charLevelText: $('#charLevelText'), charTotalHQText: $('#charTotalHQText'), charBuffsList: $('#charBuffsList'),
    devTotalHQ: $('#devTotalHQ'), devTickets: $('#devTickets'), devFreeze: $('#devFreeze'), devRareGem: $('#devRareGem'),
    devEpicGem: $('#devEpicGem'), devRareToken: $('#devRareToken'), devEpicToken: $('#devEpicToken'), devLegendToken: $('#devLegendToken'),
    btnSaveResources: $('#btnSaveResources'), btnSimulateNextDay: $('#btnSimulateNextDay'), btnResetDaily: $('#btnResetDaily'),
    btnHardReset: $('#btnHardReset'), devStateText: $('#devStateText'), btnExportState: $('#btnExportState'), btnImportState: $('#btnImportState'),
    devRewardBaseChance: $('#devRewardBaseChance'), devRewardBetCoeff: $('#devRewardBetCoeff'), devRewardMaxChance: $('#devRewardMaxChance'),
    devRewardPityInc: $('#devRewardPityInc'), btnSaveRewardParams: $('#btnSaveRewardParams'), btnResetRewardParams: $('#btnResetRewardParams'),
    // Auth elements
    authChipWrapper: $('#authChipWrapper'), btnLogin: $('#btnLogin'), btnLogout: $('#btnLogout'),
    authStatusText: $('#authStatusText'), userAvatar: $('#userAvatar'), loadingOverlay: $('#loadingOverlay'),
  };

  const sessionFlip = new FlipCounter($('#sessionFlip'),{digits:6,comma:true,large:true});
  
  const mobileTabButtons = document.querySelectorAll('.bottom-nav .tab-btn');
  const desktopTabButtons = document.querySelectorAll('.desktop-tab');
  const mainColumn = $('#mainColumn'); const timerColumn = $('#timerCard');
  const allPanes = {'tasks-pane': $('#tasks-pane'), 'backpack-pane': $('#backpack-pane'), 'club-pane': $('#club-pane'), 'you-pane': $('#you-pane')};
  const mobileMedia = window.matchMedia('(max-width: 767px) or (max-height: 500px)');
  let activeView = 'tasks-pane';

  function setView(targetId) {
    activeView = targetId;
    mobileTabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.mobileTarget === targetId));
    desktopTabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.desktopTarget === targetId));
    const isMainContent = allPanes.hasOwnProperty(targetId);
    if (mobileMedia.matches) { mainColumn.classList.toggle('mobile-hidden', !isMainContent); timerColumn.classList.toggle('mobile-hidden', targetId !== 'timerCard'); }
    Object.keys(allPanes).forEach(paneId => { if (allPanes[paneId]) { allPanes[paneId].style.display = (paneId === targetId) ? '' : 'none'; } });
    if (targetId === 'you-pane') { renderYou(); }
    window.scrollTo(0, 0);
  }

  function handleLayoutChange() {
      if (mobileMedia.matches) { const isMainContent = allPanes.hasOwnProperty(activeView); mainColumn.classList.toggle('mobile-hidden', !isMainContent); timerColumn.classList.toggle('mobile-hidden', activeView !== 'timerCard');
      } else { mainColumn.classList.remove('mobile-hidden'); timerColumn.classList.remove('mobile-hidden'); if (activeView === 'timerCard') { setView('tasks-pane'); } }
  }
  
  mobileTabButtons.forEach(btn => { btn.addEventListener('click', () => { const target = btn.dataset.mobileTarget; if (target) { const soundId = btn.dataset.soundId; if (soundId) { const soundKey = soundId.substring(3).replace(/^\w/, c => c.toLowerCase()); if (sfx[soundKey]) { playSound(sfx[soundKey]); } } setView(target); } }); });
  desktopTabButtons.forEach(tab => { tab.addEventListener('click', () => { const targetId = tab.dataset.desktopTarget; const soundId = tab.dataset.soundId; if (soundId) { const soundKey = soundId.substring(3).replace(/^\w/, c => c.toLowerCase()); if (sfx[soundKey]) { playSound(sfx[soundKey]); } } setView(targetId); }); });
  if(mobileMedia.addEventListener){ mobileMedia.addEventListener('change', handleLayoutChange); } else if(mobileMedia.addListener){ mobileMedia.addListener(handleLayoutChange); }
  handleLayoutChange();

  let tickerTimer = null, tickerTimeout = null, tickerIndex = 0;
  function clearTicker(){ if(tickerTimer){clearInterval(tickerTimer);tickerTimer=null;} if(tickerTimeout){clearTimeout(tickerTimeout);tickerTimeout=null;} }
  function rollWheelOutcomeType(){ const base=[{type:'hq',p:0.40},{type:'rare',p:0.32},{type:'epic',p:0.12},{type:'freeze',p:0.16}]; const r=Math.random(); let acc=0; for(const it of base){acc+=it.p;if(r<acc)return it.type} return 'hq'; }
  function applyWheelReward(type){
    const boost = Math.max(1, meta.nextWheelBoost || 1); let msg='';
    if(type==='hq'){ const add=Math.floor(50*boost); state.agg.totalHQ=(state.agg.totalHQ||0)+add; msg=`幸运轮获得豪情值 +${add}${boost>1?`（强运×${boost.toFixed(2)}）`:''}`; }
    else if(type==='rare'){ meta.badges.rare_gem=(meta.badges.rare_gem||0)+Math.max(1,Math.round(2*boost)); msg=`获得稀有碎片 ×${Math.max(1,Math.round(2*boost))}`; }
    else if(type==='epic'){ meta.badges.epic_gem=(meta.badges.epic_gem||0)+1; msg='获得史诗碎片 ×1'; }
    else if(type==='freeze'){ meta.freeze=(meta.freeze||0)+1; msg='获得冻结卡 ×1'; }
    meta.nextWheelBoost=1; save(); renderKPI(); renderInventory(); pushToast(msg,'success');
    if(el.wheelResult){ el.wheelResult.textContent=msg; el.wheelResult.classList.remove('muted'); }
  }
  function startNameTicker(){
    if((meta.tickets||0)<=0){pushToast('抽卡券不足', 'warn');return;}
    playSound(sfx.click); meta.tickets-=1; save(); renderInventory();
    tickerIndex = Math.floor(Math.random()*PRIZE_NAMES.length); if(el.prizeTicker) el.prizeTicker.textContent = PRIZE_NAMES[tickerIndex];
    if(el.wheelResult){el.wheelResult.textContent='跳动中…';el.wheelResult.classList.add('muted');} if(el.btnSpin) el.btnSpin.disabled=true; clearTicker();
    tickerTimer = setInterval(()=>{ tickerIndex=(tickerIndex+1)%PRIZE_NAMES.length; if(el.prizeTicker) el.prizeTicker.textContent=PRIZE_NAMES[tickerIndex]; }, 80);
    tickerTimeout = setTimeout(()=>{ clearTicker(); const outcome=rollWheelOutcomeType(); const chosen=WHEEL_SEGMENTS.find(seg=>seg.type===outcome) || WHEEL_SEGMENTS[0]; if(el.prizeTicker) el.prizeTicker.textContent=chosen.label; applyWheelReward(outcome); if(el.btnSpin) el.btnSpin.disabled=false; }, 2000);
  }

  function fmtTime(sec){ sec=Math.floor(sec); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; const pad=n=>n.toString().padStart(2,'0'); return `${h}:${pad(m)}:${pad(s)}`; }
  function fmtPause(sec){ sec=Math.max(0,Math.floor(sec||0)); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; const pad=n=>n.toString().padStart(2,'0'); return h>0?`${h}:${pad(m)}:${pad(s)}`:`${m}:${pad(s)}`;}
  window._debugDateOffset = 0;
  const getToday = () => { const d = new Date(); d.setDate(d.getDate() + (window._debugDateOffset || 0)); return d; };
  function todayKey(){ return getToday().toISOString().slice(0,10); }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  const debouncedSaveToFirebase = debounce(() => {
      const user = auth.currentUser;
      if (!user) return;
      const fullState = { tasks: state.tasks, agg: state.agg, active: state.active, meta: meta, rates: RATE_BY_DIFFICULTY, funshop: FUNSHOP, rewardParams: REWARD_PARAMS };
      db.collection('users').doc(user.uid).set(fullState, { merge: true })
        .catch(err => {
            console.error("Firestore save error:", err);
            pushToast('云端同步失败', 'warn');
        });
  }, 1500);

  function save(){
    // Always save to local storage for offline support
    writeJSON(LS_KEYS.TASKS, state.tasks);
    writeJSON(LS_KEYS.AGG, state.agg);
    writeJSON(LS_KEYS.META, meta);
    writeJSON(LS_KEYS.RATES, RATE_BY_DIFFICULTY);
    writeJSON(LS_KEYS.FUNSHOP, FUNSHOP);
    writeJSON(LS_KEYS.REWARD_PARAMS, REWARD_PARAMS);

    // If logged in, trigger a debounced save to Firestore
    if (auth.currentUser) {
      debouncedSaveToFirebase();
    }
  }

  function pushToast(message, variant='info'){
    if (variant === 'success') playSound(sfx.success);
    else if (variant === 'warn' || variant === 'err') playSound(sfx.warn);
    const wrap = el.toastWrap || document.getElementById('toastContainer'); if(!wrap) return;
    const toast = document.createElement('div'); toast.className = 'toast'; if(variant==='warn') toast.classList.add('warn'); if(variant==='success') toast.classList.add('success');
    toast.textContent = message; wrap.appendChild(toast);
    requestAnimationFrame(()=>toast.classList.add('show'));
    setTimeout(()=>{ toast.classList.remove('show'); toast.addEventListener('transitionend',()=>toast.remove(),{once:true}); },4000);
  }

  function updateModeButton() { if (!el.modeSwitchBtn) return; const isArcade = !!meta.arcade; el.modeSwitchBtn.textContent = isArcade ? '街机模式' : '专注模式'; el.modeSwitchBtn.classList.toggle('primary', !isArcade); }
  const uid=()=>Math.random().toString(36).slice(2,10);
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
  const getTask=id=>state.tasks.find(t=>t.id===id);
  function difficultyBadge(d){const map={1:"轻松",2:"较易",3:"标准",4:"较难",5:"硬仗"};return `<span class="tag">${"★".repeat(d)}${"☆".repeat(5-d)} <b style="margin-left:4px">D${d}</b> · ${map[d]}</span>`}
  const normalizeRewardAmount = val => Math.max(1, Math.floor(Number(val) || 0));
  function rewardLabel(reward){
    if(!reward||!reward.type) return ''; const def=REWARD_TYPES[reward.type]; if(!def) return '';
    const amount=normalizeRewardAmount(reward.amount||1); return `${def.label} ×${amount}`;
  }
  function grantTaskReward(task){
    if(!task||!task.reward||!task.reward.type) return null; const def=REWARD_TYPES[task.reward.type]; if(!def) return null;
    const amount=normalizeRewardAmount(task.reward.amount||1); def.apply(amount);
    return {message:`${task.title} 完成奖励：${def.label} +${amount}`, type:task.reward.type};
  }

  const WEAR_MAX = { rare_token:100, epic_token:140, legend_token:200 };
  function ensureWearPool(){ meta.funshop = meta.funshop || {activities:[], wearAccum:{}}; meta.funshop.wearAccum = meta.funshop.wearAccum || {}; }

  function parsePack(text, lead){
    if(!text) return {}; const s = text.trim().replace(/，/g,','); const t = lead && s.startsWith(lead) ? s.slice(lead.length).trim() : s;
    if(!t) return {}; const out={};
    t.split(',').map(x=>x.trim()).filter(Boolean).forEach(seg=>{ const m=seg.match(/^([a-zA-Z_]+)\*(\d+)$/); if(!m) return;
      const k=m[1].toLowerCase(); const v=Math.max(1,parseInt(m[2],10)||0); if(BADGE_META[k]) out[k]=(out[k]||0)+v; });
    return out;
  }
  function parseFunshopLines(text){
    const out=[]; (text||'').split('\n').forEach(line=>{
      const s=line.trim(); if(!s) return; const p=s.split('|'); if(p.length<2) return;
      const title=p[0].trim(); const seconds=Math.max(1,parseInt(p[1].trim(),10)||0); const need=parsePack(p[2]||'','需求:'); const wear=parsePack(p[3]||'','磨损:');
      let timeWindow=null; const w=(p[4]||'').trim(); if(w && w.startsWith('时段:')){ const m=w.slice(3).trim().match(/(\d{2}:\d{2})-(\d{2}:\d{2})/); if(m) timeWindow={start:m[1],end:m[2]}; }
      out.push({ id:uid(), title, seconds, need, wear, timeWindow, running:null }); }); return out;
  }
  function withinWindow(tw){
    if(!tw) return true; const now=getToday();
    const cur=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    return (cur>=tw.start && cur<=tw.end);
  }
  function needChipsHTML(need){
    const parts=[]; const b=meta.badges||{};
    Object.entries(need||{}).forEach(([k,v])=>{ const metaK = BADGE_META[k]; if(!metaK) return;
      let have = 0; if(metaK.invKey) have = b[metaK.invKey]||0; else if(k==='ticket') have = meta.tickets||0; else if(k==='freeze') have = meta.freeze||0;
      const ok = have>=v; const cls = ok?metaK.cls:'fb-bad';
      parts.push(`<span class="fb-chip ${cls}">${metaK.label} ×${v}${ok?``:`（缺${v-have}）`}</span>`); });
    return parts.length?parts.join(''):'<span class="funshop-muted">无</span>';
  }
  function wearChipsHTML(wear){
    const parts=[]; Object.entries(wear||{}).forEach(([k,v])=>{ const metaK = BADGE_META[k]; if(!metaK) return;
      parts.push(`<span class="fb-chip ${metaK.cls}">${metaK.label} −${v} 耐久</span>`); });
    return parts.length?parts.join(''):'<span class="funshop-muted">无</span>';
  }

  function applyWearAndConsume(need={}, wear={}){
    ensureBadgeMeta(); ensureWearPool(); const b=meta.badges||{};
    const have={ rare_token:b.rare_tokens||0, epic_token:b.epic_tokens||0, legend_token:b.legendary_tokens||0, ticket:meta.tickets||0, freeze:meta.freeze||0 };
    for(const [k,req] of Object.entries(need)){ if((have[k]||0) < req) return {ok:false,msg:`${BADGE_META[k]?.label || k} 不足`}; }
    if(need.rare_token){ meta.badges.rare_tokens = Math.max(0,(meta.badges.rare_tokens||0) - need.rare_token); }
    if(need.epic_token){ meta.badges.epic_tokens = Math.max(0,(meta.badges.epic_tokens||0) - need.epic_token); }
    if(need.legend_token){ meta.badges.legendary_tokens = Math.max(0,(meta.badges.legendary_tokens||0) - need.legend_token); }
    if(need.ticket){ meta.tickets = Math.max(0,(meta.tickets||0) - need.ticket); }
    if(need.freeze){ meta.freeze  = Math.max(0,(meta.freeze||0)  - need.freeze); }
    const pool=meta.funshop.wearAccum; Object.entries(wear||{}).forEach(([k,v])=>{ if(WEAR_MAX[k]) pool[k]=(pool[k]||0)+Math.max(0,v); });
    const report=[];
    [['rare_token','rare_tokens'],['epic_token','epic_tokens'],['legend_token','legendary_tokens']].forEach(([k,invKey])=>{
      const max=WEAR_MAX[k]; const have=meta.badges[invKey]||0; const w=pool[k]||0; const destroy=Math.min(have, Math.floor(w/max));
      if(destroy>0){ meta.badges[invKey]=Math.max(0,have-destroy); pool[k]=w - destroy*max; report.push(`${BADGE_META[k]?.label || k} -${destroy}`); } });
    return {ok:true,destroyed:report};
  }

  function renderFunshop(){
    const list = el.funshopList; if(!list) return; ensureBadgeMeta(); ensureWearPool();
    const acts = meta.funshop.activities||[]; const fragment = document.createDocumentFragment();
    if(!acts.length){ list.innerHTML = `<div class="funshop-muted">尚未配置娱乐活动。点右上角“调试/导入”。</div>`; return; }
    acts.forEach(a=>{ const row=document.createElement('div'); row.className='funshop-item'; const inTime=withinWindow(a.timeWindow);
      const timerHTML = a.running ? `<span class="mini-timer">进行中 · 剩余 <b><span class="remain" data-id="${a.id}">${fmtTime(Math.max(0,Math.ceil((a.running.until-Date.now())/1000)))}</span></b><button class="btn small" data-stop="${a.id}">停止</button></span>` : '';
      row.innerHTML = `
        <div class="funshop-grid-2"><div><b>${a.title}</b> <span class="funshop-muted">（${fmtTime(a.seconds)}）</span></div><div>${a.timeWindow?`<span class="funshop-muted">${inTime?'时段开放':'当前不在时段'}：${a.timeWindow.start}–${a.timeWindow.end}</span>`:''}</div></div>
        <div class="fb-line"><span class="funshop-muted">需求：</span>${needChipsHTML(a.need)}</div>
        <div class="fb-line"><span class="funshop-muted">磨损：</span>${wearChipsHTML(a.wear)}</div>
        <div class="funshop-row">${timerHTML}<span style="flex:1"></span><button class="btn small${inTime?'':' disabled'}" data-play="${a.id}" ${inTime?'':'disabled'}>${inTime?'兑换并开始':'未到时段'}</button></div>`;
      const play = row.querySelector(`[data-play="${a.id}"]`); if(play) play.onclick=()=>startFunActivity(a.id);
      const stop = row.querySelector(`[data-stop="${a.id}"]`); if(stop) stop.onclick=()=>stopFunActivity(a.id,true);
      fragment.appendChild(row); });
    list.innerHTML = ''; list.appendChild(fragment);
  }

  function startFunActivity(id){
    ensureBadgeMeta(); ensureWearPool(); const acts=meta.funshop.activities||[]; const a=acts.find(x=>x.id===id); if(!a) return;
    if(a.running){ pushToast('已在进行中','warn'); return; } const res = applyWearAndConsume(a.need||{}, a.wear||{});
    if(!res.ok){ pushToast(res.msg||'条件不足','warn'); save(); renderInventory(); return; }
    if(res.destroyed && res.destroyed.length){ pushToast(`磨损导致销毁：${res.destroyed.join('、')}`,'warn'); }
    a.running = { until: Date.now() + Math.max(1,a.seconds)*1000 }; save(); renderInventory(); renderFunshop();
  }
  function stopFunActivity(id,byUser=false){ const acts=meta.funshop.activities||[]; const a=acts.find(x=>x.id===id); if(!a||!a.running) return;
    a.running=null; save(); renderFunshop(); if(byUser) pushToast('已停止娱乐活动','info');
  }
  function tickFunshopTimers(){
    const acts=meta.funshop.activities||[]; let dirty=false; const now=Date.now();
    acts.forEach(a=>{ if(a.running && a.running.until<=now){ a.running=null; dirty=true; }}); if(dirty){ save(); renderFunshop(); }
    document.querySelectorAll('.mini-timer .remain').forEach(span=>{ const id = span.getAttribute('data-id'); const a = acts.find(x=>x.id===id);
      if(a && a.running){ span.textContent = fmtTime(Math.max(0,Math.ceil((a.running.until-Date.now())/1000))); } });
    setTimeout(tickFunshopTimers,1000);
  }

  function renderKPI() {
      if (el.kpiTotalValue) el.kpiTotalValue.textContent = Math.floor(state.agg.totalHQ || 0).toLocaleString('en-US');
      if (el.kpiTime) el.kpiTime.textContent = fmtTime(state.agg.totalSeconds || 0);
  }

  function renderHeaderStatus() {
      const headerStatusEl = document.getElementById('mobileHeaderStatus');
      if (!headerStatusEl) return;
      
      const totalHQ = state.agg.totalHQ || 0;
      const hqForLevelUp = 1000;
      const currentLevel = Math.floor(totalHQ / hqForLevelUp) + 1;
      const currentLevelBaseHQ = (currentLevel - 1) * hqForLevelUp;
      const hqInCurrentLevel = totalHQ - currentLevelBaseHQ;
      const percent = Math.min(100, (hqInCurrentLevel / hqForLevelUp) * 100);

      const name = (meta.character && meta.character.name) ? meta.character.name : '英雄';
      const title = (meta.character && meta.character.title) ? meta.character.title : '初出茅庐';
      
      const now = Date.now();
      const activeBuffs = (meta.buffs || []).filter(b => b.expiresAt > now);
      const buffText = activeBuffs.length > 0 ? `${activeBuffs.length}个Buff生效中` : '';

      const avatarUrl = meta.character.avatar || '';

      headerStatusEl.innerHTML = `
      <div class="mobile-header-card">
          <div class="mobile-char-avatar" style="background-image: ${avatarUrl ? `url(${avatarUrl})` : 'none'};">
              ${!avatarUrl ? '👤' : ''}
          </div>
          <div class="mobile-char-details">
              <div class="mobile-char-status">
                  <div class="char-info">
                      <span class="char-name">${name}</span>
                      <span class="char-title">${title}</span>
                  </div>
                  <div class="exp-bar-container">
                      <div class="exp-bar-header">
                          <span class="exp-level">Lv.${currentLevel}</span>
                          <span class="exp-buffs">${buffText}</span>
                      </div>
                      <div class="exp-bar">
                          <div class="exp-bar-fill" style="width: ${percent}%;"></div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      `;
  }

  function renderTasks(){
    el.emptyTask.style.display = state.tasks.length?'none':'block'; const fragment = document.createDocumentFragment();
    const currentDisplayTaskId = (state.active && state.active.taskId) || state.selectedTaskId;
    state.tasks.forEach(t=>{ const row=document.createElement('div'); row.className='task'; if(currentDisplayTaskId ===t.id) row.classList.add('selected');
      row.innerHTML = `
        <div>${difficultyBadge(t.difficulty)}</div>
        <div> <div class="task-title">${t.title}</div> <div class="task-meta">累计豪情值：<b>${Math.floor(t.totalHQ||0)}</b> · 累计用时：<b>${fmtTime(t.totalSeconds||0)}</b></div> ${t.reward&&rewardLabel(t.reward)?`<div class="reward-tag">奖励：${rewardLabel(t.reward)}</div>`:''} </div>
        <div class="controls"><button class="btn small" data-act="edit">编辑</button><button class="btn small danger" data-act="del">删除</button></div>
        <div><button class="btn small accent" data-act="select">${currentDisplayTaskId === t.id ? '已选':'选择'}</button></div>`;
      row.querySelector('[data-act="edit"]').onclick=()=>editTask(t.id); row.querySelector('[data-act="del"]').onclick=()=>deleteTask(t.id);
      row.querySelector('[data-act="select"]').onclick=()=>selectTask(t.id); fragment.appendChild(row); });
    el.taskList.innerHTML = ''; el.taskList.appendChild(fragment);
  }

function setControls(){
  const btnStart = el.btnStart; const btnPause = el.btnPause; const btnStop  = el.btnStop; if(!btnStart || !btnPause || !btnStop) return;
  const setStartState = (disabled, label) => { btnStart.disabled = disabled; btnStart.textContent = label; btnStart.setAttribute('aria-label', label); };
  setStartState(true, '开始'); btnPause.disabled = true; btnStop.disabled  = true;
  if (state.active) { const a = state.active; if (!a.isPaused) { setStartState(true, '开始'); btnPause.disabled = false; btnStop.disabled = false; } else { setStartState(false, '继续'); btnPause.disabled = true; btnStop.disabled = false; }
  } else if (state.selectedTaskId) { setStartState(false, '开始'); }
}
  function showPauseIndicator(sec){ if(!el.pauseIndicator||!el.pauseTime) return; el.pauseIndicator.style.display='flex'; el.pauseTime.textContent=fmtPause(sec); }
  function hidePauseIndicator(){ if(!el.pauseIndicator||!el.pauseTime) return; el.pauseIndicator.style.display='none'; el.pauseTime.textContent='0:00'; }

  function addTask(){
    const title=el.taskTitle.value.trim(); const diff=parseInt(el.taskDiff.value,10); if(!title){playSound(sfx.warn); alert('请输入任务标题');return}
    playSound(sfx.add); state.tasks.unshift({id:uid(), title, difficulty:diff, totalHQ:0, totalSeconds:0});
    save(); renderTasks(); el.taskTitle.value='';
  }
  function editTask(id){
    const t=getTask(id); if(!t) return; const title=prompt('编辑任务标题：',t.title); if(title===null) return;
    let diff=prompt('编辑难度（1-5）：',t.difficulty); if(diff===null) return;
    diff=clamp(parseInt(diff,10)||t.difficulty,1,5);
    t.title=(title.trim()||t.title); t.difficulty=diff; playSound(sfx.click);
    save(); renderTasks(); if((state.active && state.active.taskId === id) || state.selectedTaskId === id){ updateRate(); }
  }
  function deleteTask(id){
    if(state.active&&state.active.taskId===id){ playSound(sfx.warn); alert('请先结束当前任务的计时，再删除。'); return; }
    if(state.selectedTaskId === id) { state.selectedTaskId = null; } playSound(sfx.delete);
    state.tasks=state.tasks.filter(t=>t.id!==id); save(); renderTasks();
  }

  function baseRateOfTask(task){return RATE_BY_DIFFICULTY[task.difficulty]||1;}
  function todayBuff(){const day=todayKey(); meta.dailyBuff=meta.dailyBuff||{}; meta.dailyBuff[day]=meta.dailyBuff[day]||{rateBuff:0}; return meta.dailyBuff[day];}
  function effectiveRate(baseRate, difficulty){ let rate=baseRate; const chip = todayBuff().rateBuff || 0; rate *= (1 + chip); return rate; }
  function rateOfActive(){ if(!state.active) return 0; const task=getTask(state.active.taskId); if(!task) return 0; return effectiveRate(baseRateOfTask(task), task.difficulty); }
  
  function updateRate(){
    let task; if (state.active) { task = getTask(state.active.taskId); } else if (state.selectedTaskId) { task = getTask(state.selectedTaskId); }
    if(!task){ el.rateText.textContent='0'; return; } const eff=effectiveRate(baseRateOfTask(task), task.difficulty);
    el.rateText.textContent=eff.toFixed(2);
  }

  function selectTask(id){
    const t=getTask(id); if(!t) return;
    if(state.active && state.active.taskId !== id) { pushToast('当前有任务正在计时，请先结束。', 'warn'); return; }
    if(state.active && state.active.taskId === id) return; playSound(sfx.select); state.selectedTaskId = id;
    el.activeHint.textContent=`已选择：${t.title}（难度 ${t.difficulty}）`; sessionFlip.setValue(0,true); 
    el.sessionTime.textContent='0:00:00'; el.taskTotal.textContent=Math.floor(t.totalHQ||0); el.taskTime.textContent=fmtTime(t.totalSeconds||0);
    hidePauseIndicator(); updateRate(); renderTasks(); setControls();
    if (mobileMedia.matches) { setView('timerCard'); }
  }
  
  function startTimer(){
    if (state.active && !state.active.isPaused) return;
    const taskId = state.active ? state.active.taskId : state.selectedTaskId; if (!taskId) { playSound(sfx.warn); alert('请先选择任务'); return; }
    const task = getTask(taskId); if (!task) return; playSound(sfx.timerStart);
    let newTimerState; const now = Date.now();
    if (state.active && state.active.isPaused) { const pausedDurationSec = (now - state.active.pauseTime) / 1000; newTimerState = { ...state.active, startTime: now, isPaused: false, pauseTime: null, pauses: (state.active.pauses || 0) + (pausedDurationSec > ECON.pauseBreakSec ? 1 : 0), };
    } else { newTimerState = { taskId: taskId, startTime: now, accumulatedSeconds: 0, isPaused: false, pauseTime: null, pauses: 0, }; }
    state.selectedTaskId = null; state.active = newTimerState; save();
    el.activeHint.textContent = `进行中：${task.title}（难度 ${task.difficulty}）`;
    renderTasks(); updateRate(); setControls(); hidePauseIndicator();
  }

  function pauseTimer(){
    if(!state.active || state.active.isPaused) return; playSound(sfx.timerPause); const now = Date.now();
    const elapsedSec = (now - state.active.startTime) / 1000;
    const newTimerState = { ...state.active, accumulatedSeconds: (state.active.accumulatedSeconds || 0) + elapsedSec, isPaused: true, pauseTime: now, startTime: null, };
    state.active = newTimerState; save(); setControls();
    const task = getTask(state.active.taskId);
    if(task) { const rate = effectiveRate(baseRateOfTask(task), task.difficulty);
      const finalSessionHQ = (state.active.accumulatedSeconds || 0) * rate; const finalSessionSeconds = state.active.accumulatedSeconds || 0;
      sessionFlip.setValue(Math.floor(finalSessionHQ), true); el.sessionTime.textContent = fmtTime(finalSessionSeconds);
      el.taskTotal.textContent = Math.floor((task.totalHQ || 0) + finalSessionHQ);
      el.taskTime.textContent = fmtTime((task.totalSeconds || 0) + finalSessionSeconds);
    }
  }

  function pushTodayDone(entry){ const d = todayObj(); d.completed.unshift(entry); save(); }
  function renderTodayDone(){
    const d = todayObj(); const list = d.completed || []; const box = document.getElementById('todayDoneBody'); if(!box) return;
    if(list.length === 0){ box.innerHTML = '<div class="muted">今天还没有完成的任务。</div>'; return; }
    const fragment = document.createDocumentFragment(); list.forEach(it => { const item = document.createElement('div');
        item.className = 'pane';
        item.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:8px"> <div style="font-weight:600">${it.title}</div> <span class="tag">D${it.difficulty}</span> </div> <div class="muted" style="margin-top:6px;font-size:12px"> 用时：<b>${fmtTime(it.seconds)}</b> · 本次豪情值：<b>${Math.floor(it.hq)}</b> · 完成于：${new Date(it.ts).toLocaleTimeString()} </div>`;
        fragment.appendChild(item); });
    box.innerHTML = ''; box.appendChild(fragment);
  }

  function bindRewardClose() { const closeBtn = el.btnCloseReward; if (closeBtn) { closeBtn.onclick = () => { playSound(sfx.modalClose); el.rewardMask.style.display = 'none'; }; } }

  function openReward({baseHQ, seconds, difficulty, rawHQ}){
    playSound(sfx.modalOpen); const streakMulti = 1 + (meta.streak || 0);
    const baseReward = Math.floor(baseHQ * streakMulti); const isArcade = !!meta.arcade;
    const body = el.rewardBody; if(!body) return;
    body.innerHTML = ` <div style="text-align:center;margin-bottom:16px"> <div style="font-size:24px;font-weight:800;margin-bottom:4px">${baseReward}</div> <div class="muted">基础奖励（连击 ×${streakMulti.toFixed(2)}）</div> </div> ${isArcade ? ` <div class="choice" id="betChoice"> <div class="opt" data-bet="0">不押注</div> <div class="opt" data-bet="0.5">押注 ×0.5（${Math.floor(baseReward*0.5)}）</div> <div class="opt" data-bet="1">押注 ×1（${baseReward}）</div> <div class="opt" data-bet="2">押注 ×2（${Math.floor(baseReward*2)}）</div> </div> <div class="muted" style="margin-top:10px;font-size:12px">街机模式：可押注赢取更多豪情值，失败则失去基础奖励</div> ` : ''} `;
    if(isArcade){
      const opts = body.querySelectorAll('.opt');
      opts.forEach(opt => { opt.onclick = () => { playSound(sfx.click); const bet = parseFloat(opt.dataset.bet);
          if(bet === 0){ state.agg.totalHQ = (state.agg.totalHQ || 0) + baseReward; save(); renderKPI(); body.innerHTML += `<div class="result-bar result-ok" style="margin-top:16px">已领取基础奖励 +${baseReward}</div>`; bindRewardClose();
          }else{ const cost = Math.floor(baseReward * bet); const chance = Math.min(REWARD_PARAMS.maxChance, REWARD_PARAMS.baseChance + bet * REWARD_PARAMS.betCoefficient + (meta.pity || 0));
            const won = Math.random() < chance; const loot = won ? Math.floor(cost * (1.5 + Math.random() * 1.5)) : 0;
            if(won){ state.agg.totalHQ = (state.agg.totalHQ || 0) + loot; meta.pity = Math.max(0, (meta.pity || 0) - ECON.pityStep);
              body.innerHTML += `<div class="result-bar result-ok" style="margin-top:16px"> <div>🎉 押注成功！获得 +${loot} 豪情值</div> <div class="loots" style="margin-top:8px"> <span class="loot">基础消耗：${cost}</span> <span class="loot">倍率：×${(loot/cost).toFixed(2)}</span> <span class="loot">怜悯：+${(chance*100).toFixed(1)}%</span> </div> </div>`;
            }else{ meta.pity = (meta.pity || 0) + REWARD_PARAMS.pityIncrement;
              body.innerHTML += `<div class="result-bar result-err" style="margin-top:16px"> <div>💥 押注失败，失去基础奖励 -${baseReward}</div> <div class="loots" style="margin-top:8px"> <span class="loot">怜悯+${(REWARD_PARAMS.pityIncrement*100).toFixed(1)}%</span> </div> </div>`;
            } save(); renderKPI(); } bindRewardClose(); }; });
    }else{ state.agg.totalHQ = (state.agg.totalHQ || 0) + baseReward; save(); renderKPI(); body.innerHTML += `<div class="result-bar result-ok" style="margin-top:16px">已领取基础奖励 +${baseReward}</div>`; bindRewardClose(); }
    el.rewardMask.style.display = 'flex';
  }

  function triggerCompletionAnimation() {
    const container = document.getElementById('completion-animation-container'); if (!container) return; container.innerHTML = '';
    const textEl = document.createElement('div'); textEl.className = 'completion-text'; textEl.textContent = '任务完成!'; container.appendChild(textEl);
    const confettiCount = 50; const colors = ['var(--primary)', 'var(--accent)', '#e3b341', '#3fb950'];
    for (let i = 0; i < confettiCount; i++) { const confetti = document.createElement('div'); confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}vw`; confetti.style.top = `${Math.random() * -20}vh`;
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; confetti.style.animationDelay = `${Math.random() * 0.5}s`;
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`; container.appendChild(confetti); }
    setTimeout(() => { container.innerHTML = ''; }, 2500);
  }

  function stopTimer(){
    if(!state.active) return; playSound(sfx.timerStop);
    const activeSession = { ...state.active }; state.active = null;
    const t = getTask(activeSession.taskId); let sessionSeconds = activeSession.accumulatedSeconds || 0;
    if (!activeSession.isPaused && activeSession.startTime) { sessionSeconds += (Date.now() - activeSession.startTime) / 1000; }
    sessionSeconds = Math.floor(sessionSeconds);
    const taskRate = t ? effectiveRate(baseRateOfTask(t), t.difficulty) : 0;
    const sessionHQ = Math.floor(sessionSeconds * taskRate); const pauses = activeSession.pauses || 0;
    const diff = t ? t.difficulty : 3;
    if(t){ t.totalHQ = (t.totalHQ || 0) + sessionHQ; t.totalSeconds = (t.totalSeconds || 0) + sessionSeconds; }
    state.agg.totalSeconds = (state.agg.totalSeconds || 0) + sessionSeconds;
    pushTodayDone({ title: t ? t.title : '未知任务', difficulty: diff, seconds: sessionSeconds, hq: sessionHQ, ts: Date.now() });
    triggerCompletionAnimation(); const extraReward = grantTaskReward(t);
    state.tasks = state.tasks.filter(task => task.id !== activeSession.taskId); if(state.selectedTaskId === activeSession.taskId) state.selectedTaskId = null;
    save(); renderTasks(); renderKPI();
    el.activeHint.textContent='未选择任务'; sessionFlip.setValue(0,true); el.sessionTime.textContent='0:00:00'; el.taskTotal.textContent='0';
    el.taskTime.textContent='0:00:00'; el.rateText.textContent='0'; hidePauseIndicator(); setControls();
    if(extraReward){ if(extraReward.type!=='hq'){ renderInventory(); } pushToast(extraReward.message,'success'); }
    setTimeout(() => { onSegmentEnd_base(sessionSeconds, diff, pauses); singleMissionJudge(sessionSeconds, diff, pauses);
        openReward({ baseHQ: sessionHQ, seconds: sessionSeconds, difficulty: diff, rawHQ: sessionHQ }); }, 1800);
  }

  let lastKnownTotalHQForDisplay = 0;
  function loop(){
      if (state.active && !state.active.isPaused) { const a = state.active; const task = getTask(a.taskId);
          if (task) { const rate = rateOfActive(); const elapsedSinceStart = (Date.now() - a.startTime) / 1000;
              const currentSessionSeconds = (a.accumulatedSeconds || 0) + elapsedSinceStart; const currentSessionHQ = currentSessionSeconds * rate;
              sessionFlip.flipTo(Math.floor(currentSessionHQ)); el.sessionTime.textContent = fmtTime(currentSessionSeconds);
              el.taskTotal.textContent = Math.floor((task.totalHQ || 0) + currentSessionHQ);
              el.taskTime.textContent = fmtTime((task.totalSeconds || 0) + currentSessionSeconds);
              lastKnownTotalHQForDisplay = Math.floor((state.agg.totalHQ || 0) + currentSessionHQ);
              el.kpiTotalValue.textContent = lastKnownTotalHQForDisplay.toLocaleString('en-US'); }
      } else if (state.active && state.active.isPaused) { const pausedFor = (Date.now() - (state.active.pauseTime || Date.now())) / 1000;
          showPauseIndicator(pausedFor); el.kpiTotalValue.textContent = lastKnownTotalHQForDisplay.toLocaleString('en-US');
      } else { hidePauseIndicator(); lastKnownTotalHQForDisplay = Math.floor(state.agg.totalHQ || 0);
          el.kpiTotalValue.textContent = lastKnownTotalHQForDisplay.toLocaleString('en-US'); }
      
      if (activeView === 'you-pane') { let statusText = '离线';
        if (state.active) { statusText = state.active.isPaused ? '休息中' : '专注中'; }
        if (el.charStatusTag) el.charStatusTag.textContent = statusText;
        const now = Date.now(); meta.buffs = (meta.buffs || []).filter(b => b.expiresAt > now);
        const buffList = el.charBuffsList;
        if (buffList) { if (meta.buffs.length === 0) { buffList.innerHTML = `<div class="char-buff-item muted">无</div>`; } else {
                buffList.innerHTML = meta.buffs.map(buff => { const remainingSec = Math.max(0, Math.floor((buff.expiresAt - now) / 1000));
                    const m = Math.floor(remainingSec / 60).toString().padStart(2, '0');
                    const s = (remainingSec % 60).toString().padStart(2, '0');
                    return `<div class="char-buff-item">${buff.name}（剩余 ${m}:${s}）</div>`; }).join(''); } }
      }
      renderHeaderStatus();
      requestAnimationFrame(loop);
  }
  
  document.addEventListener('visibilitychange',()=>{ if(document.hidden && state.active && !state.active.isPaused){ pauseTimer(); }});
  
  if (el.modeSwitchBtn) { el.modeSwitchBtn.addEventListener('click', () => { playSound(sfx.click); meta.arcade = !meta.arcade; save(); updateModeButton(); pushToast(`已切换到${meta.arcade ? '街机' : '专注'}模式`); }); }
  if (el.btnHelp) el.btnHelp.onclick=()=>{ playSound(sfx.modalOpen); el.helpMask.style.display='flex'; };
  el.btnCloseHelp.onclick=()=>{ playSound(sfx.modalClose); el.helpMask.style.display='none'; };
  el.btnCloseDev.onclick=()=>{ playSound(sfx.modalClose); el.devMask.style.display='none'; };
  el.btnSaveRates.onclick=()=>{ playSound(sfx.click); const r1=parseFloat(el.rate1.value)||0, r2=parseFloat(el.rate2.value)||0, r3=parseFloat(el.rate3.value)||0, r4=parseFloat(el.rate4.value)||0, r5=parseFloat(el.rate5.value)||0; RATE_BY_DIFFICULTY={1:Math.max(0,r1),2:Math.max(0,r2),3:Math.max(0,r3),4:Math.max(0,r4),5:Math.max(0,r5)}; save(); updateRate(); pushToast('速率已保存并应用','success'); };
  el.btnResetRates.onclick=()=>{ playSound(sfx.click); RATE_BY_DIFFICULTY={...DEFAULT_RATES}; save(); updateRate(); pushToast('已恢复默认速率','success'); };
  el.btnAdd.onclick=addTask; el.taskTitle.addEventListener('keydown',e=>{ if(e.key==='Enter') addTask(); });
  el.btnClearAll.onclick=()=>{ playSound(sfx.click); if(confirm('清空所有任务与累计数据（不清空库存/连胜/每日/速率），确定？')){ state.tasks=[]; state.agg={totalHQ:0,totalSeconds:0}; state.active=null; save(); renderTasks(); renderKPI(); setControls(); el.activeHint.textContent='未选择任务'; sessionFlip.setValue(0,true); el.sessionTime.textContent='0:00:00'; el.taskTotal.textContent='0'; el.taskTime.textContent='0:00:00'; el.rateText.textContent='0'; } };
  el.btnStart.onclick=startTimer; el.btnPause.onclick=pauseTimer; el.btnStop.onclick=stopTimer;

  function setupButtonPair(mobileId, desktopId, callback) { const mobileBtn = document.getElementById(mobileId); const desktopBtn = document.getElementById(desktopId); if (mobileBtn) mobileBtn.onclick = callback; if (desktopBtn) desktopBtn.onclick = callback; }
  const refreshMissionsAction = () => { playSound(sfx.click); const ok = rollMissions(false, false); if (ok) { save(); renderDaily(); renderInventory(); pushToast('已刷新每日任务', 'success'); } };
  el.btnDailyRefresh.onclick = refreshMissionsAction;

function todayObj(){ const k = todayKey(); if (!meta.daily[k]) { meta.daily[k] = { progressSec: 0, hardSec: 0, sessions: 0, zeroPauseSessions: 0, missions: null, refreshUsed: false, done: {}, completed: [] }; } if (!Array.isArray(meta.daily[k].completed)) { meta.daily[k].completed = []; } return meta.daily[k]; }
  const FIXED_MISSIONS=[{id:'total25',type:'totalSec',need:25*60,label:'今日累计 ≥ 25 分钟',reward:{ticket:1}},{id:'total45',type:'totalSec',need:45*60,label:'今日累计 ≥ 45 分钟',reward:{freeze:1}}];
  const RANDOM_POOL=[{id:'total90',type:'totalSec',need:90*60,label:'今日累计 ≥ 90 分钟',reward:{ticket:2}},{id:'single15',type:'singleSec',need:15*60,label:'单次 ≥ 15 分钟',reward:{ticket:1}},{id:'single30',type:'singleSec',need:30*60,label:'单次 ≥ 30 分钟',reward:{ticket:2}},{id:'hard20',type:'hardSec',need:20*60,label:'难度≥4 今日累计 ≥ 20 分钟',reward:{ticket:1}},{id:'noPause10',type:'noPauseSingle',need:10*60,label:'单次 ≥ 10 分钟且无暂停',reward:{freeze:1}},{id:'sessions3',type:'sessions',need:3,label:'今日完成 ≥ 3 次计时',reward:{ticket:1}}];
  function addTodayProgress({seconds,difficulty,pauses}){const d=todayObj(); d.progressSec+=seconds; if(difficulty>=4) d.hardSec+=seconds; d.sessions+=1; if(pauses===0 && seconds>=10*60) d.zeroPauseSessions+=1; save(); renderDaily();}
  function onSegmentEnd_base(seconds,difficulty,pauses){ if(seconds>=ECON.baseFloorMinSec){ meta.streak=+(meta.streak+ECON.streakStep).toFixed(2)} addTodayProgress({seconds,difficulty,pauses}); save(); }
  function singleMissionJudge(seconds,diff,pauses){ const d=todayObj(); if(!d.missions) return; d.missions.forEach(m=>{ if(d.done[m.id]) return; if(m.type==='singleSec' && seconds>=m.need) d.done[m.id]=true; if(m.type==='noPauseSingle' && seconds>=m.need && pauses===0) d.done[m.id]=true; }); save(); renderDaily(); }
  function rollMissions(firstFree=false,useRare=false){
    const d=todayObj(); if(useRare){ if((meta.badges.rare_gem||0)<6){alert('稀有碎片不足');return false;} meta.badges.rare_gem-=6; }
    else{ if(d.refreshUsed && (meta.tickets||0)<=0){alert('抽卡券不足（每日首次刷新免费）');return false;} if(d.refreshUsed) meta.tickets-=1; }
    d.refreshUsed=true; const pool=[...RANDOM_POOL], pick=[]; for(let i=0;i<3;i++){const j=Math.floor(Math.random()*pool.length); pick.push(pool.splice(j,1)[0]);}
    d.missions=[...FIXED_MISSIONS,...pick]; d.done={}; save(); renderDaily(); renderInventory(); return true;
  }
  function renderDaily(){
    const d=todayObj(); if(!d.missions){rollMissions(true);return} const fragment = document.createDocumentFragment();
    d.missions.forEach(m=>{ const ok=(()=>{if(m.type==='totalSec')return d.progressSec>=m.need; if(m.type==='hardSec')return d.hardSec>=m.need; if(m.type==='sessions')return d.sessions>=m.need; return false})();
      const done=!!d.done[m.id]; const progress=(()=>{if(m.type==='totalSec')return `${fmtTime(Math.min(d.progressSec,m.need))}/${fmtTime(m.need)}`; if(m.type==='hardSec')return `${fmtTime(Math.min(d.hardSec,m.need))}/${fmtTime(m.need)}`; if(m.type==='sessions')return `${Math.min(d.sessions,m.need)}/${m.need}`; if(m.type==='singleSec')return `完成一次 ≥ ${fmtTime(m.need)}`; if(m.type==='noPauseSingle')return `完成一次 ≥ ${fmtTime(m.need)}(0暂停)`; return ''})();
      const buttonText = done ? '已领取' : '领取'; const row = document.createElement('div'); row.className = 'daily-task-card';
      row.innerHTML = `<div class="daily-task-info"> <div class="daily-task-label">${m.label}</div> <div class="daily-task-progress muted">${progress ? `${progress}` : ''}</div> </div> <div class="daily-task-action"> <button class="btn small" ${(!ok || done) ? 'disabled' : ''}>${buttonText}</button> </div>`;
      row.querySelector('button').onclick=()=>{ if(done||!ok)return; playSound(sfx.success); d.done[m.id]=true; if(m.reward.ticket)meta.tickets=(meta.tickets||0)+m.reward.ticket; if(m.reward.freeze)meta.freeze=(meta.freeze||0)+m.reward.freeze; save(); renderDaily(); renderInventory(); };
      fragment.appendChild(row); });
    el.dailyList.innerHTML = ''; el.dailyList.appendChild(fragment);
  }

  function renderInventory(){
    ensureBadgeMeta(); const b=meta.badges||{}; const buff=todayBuff();
    el.invRow.innerHTML=`<div class="badge">稀有碎片：<b>${b.rare_gem||0}</b></div><div class="badge">史诗碎片：<b>${b.epic_gem||0}</b></div><div class="badge">稀有徽章：<b>${b.rare_tokens||0}</b></div><div class="badge">史诗徽章：<b>${b.epic_tokens||0}</b></div><div class="badge">传说徽章：<b>${b.legendary_tokens||0}</b></div><div class="badge">冻结卡：<b>${meta.freeze||0}</b></div><div class="badge">抽卡券：<b>${meta.tickets||0}</b></div><div class="badge">当日速率加成：<b>${Math.round((buff.rateBuff||0)*100)}%</b></div>${meta.nextWheelBoost>1?`<div class="badge">下一次幸运轮奖池 ×${meta.nextWheelBoost.toFixed(2)}</div>`:''}`;
    renderWorkshop();
  }

  function renderWorkshop(){
    const body = el.badgeWorkshopBody; if (!body) return; ensureBadgeMeta(); const b = meta.badges || {};
    const rare = b.rare_gem || 0; const epic = b.epic_gem || 0;
    body.innerHTML = ` <div class="workshop-section"> <div class="muted" style="margin-bottom:6px">碎片库存</div> <div class="badge-card">稀有碎片：<b>${rare}</b> · 史诗碎片：<b>${epic}</b></div> </div> <div class="workshop-section"> <div class="muted" style="margin-bottom:6px">合成与消耗</div> <div class="loadout-grid"> <div class="loadout-slot"> <div class="muted">合成冻结卡（稀有×15）</div> <button class="btn small" id="wsForgeFreeze"${rare<15?' disabled':''}>锻造</button> </div> <div class="loadout-slot"> <div class="muted">刷新每日（稀有×6）</div> <button class="btn small" id="wsRareRefresh"${rare<6?' disabled':''}>使用</button> </div> <div class="loadout-slot"> <div class="muted">幸运轮强运（稀有×10）</div> <button class="btn small" id="wsWheelBoost"${rare<10?' disabled':''}>注入</button> </div> <div class="loadout-slot"> <div class="muted">调速芯片 +5%（稀有×20，上限20%）</div> <button class="btn small" id="wsSpeedChip"${rare<20?' disabled':''}>安装</button> </div> </div> </div> `;
    const bind = (id, fn) => { const x = document.getElementById(id); if (x) x.onclick = fn; };
    bind('wsForgeFreeze', forgeFreeze); bind('wsRareRefresh', rareRefresh); bind('wsWheelBoost', activateWheelBoost); bind('wsSpeedChip', applySpeedChip);
  }

  function forgeFreeze(){ playSound(sfx.click); if((meta.badges.rare_gem||0)<15){alert('稀有碎片不足');return;} meta.badges.rare_gem-=15; meta.freeze=(meta.freeze||0)+1; save(); renderInventory(); pushToast('锻造成功，获得冻结卡×1','success'); }
  function rareRefresh(){ playSound(sfx.click); if(rollMissions(false,true)){ save(); renderInventory(); pushToast('已使用稀有碎片刷新每日任务','success'); } }
  function activateWheelBoost(){ playSound(sfx.click); if((meta.badges.rare_gem||0)<10){alert('稀有碎片不足');return;} meta.badges.rare_gem-=10; meta.nextWheelBoost=Math.min((meta.nextWheelBoost||1)*1.5,3); save(); renderInventory(); pushToast('已注入强运，下一次幸运轮提升','success'); }
  function applySpeedChip(){ playSound(sfx.click); if((meta.badges.rare_gem||0)<20){alert('稀有碎片不足');return;} const buff=todayBuff(); if(buff.rateBuff>=0.20){alert('今日加成已达上限');return;} meta.badges.rare_gem-=20; buff.rateBuff=+(Math.min(0.20,(buff.rateBuff||0)+0.05).toFixed(2)); save(); renderInventory(); updateRate(); pushToast('当日基础速率 +5%','success'); }
  
  const openTaskLibrary = () => { playSound(sfx.modalOpen); el.taskLibraryMask.style.display = 'flex'; }; el.btnTaskLibrary.onclick = openTaskLibrary;
  if(el.btnCloseTaskLibrary) el.btnCloseTaskLibrary.onclick=()=>{ playSound(sfx.modalClose); el.taskLibraryMask.style.display='none'; };
  if(el.btnImportTasks) el.btnImportTasks.onclick=()=>{
    playSound(sfx.click); const inputText = (el.taskLibraryInput.value||'').trim(); if(!inputText){ pushToast('任务库输入为空','warn'); return; }
    const lines = inputText.split('\n'); let imported=0;
    lines.forEach(line=>{ const s=line.trim(); if(!s) return; const parts = s.split('|');
      if(parts.length<2){ pushToast(`跳过无效行: ${s}`,'warn'); return; } const title=parts[0].trim(); const difficulty=parseInt((parts[1]||'').trim(),10);
      if(!title || isNaN(difficulty) || difficulty<1 || difficulty>5){ pushToast(`跳过无效任务: ${s}`,'warn'); return; }
      let reward=null; const rewardTypeKey=(parts[2]||'').trim().toLowerCase();
      if(rewardTypeKey){ if(!REWARD_TYPES[rewardTypeKey]){ pushToast(`未知奖励类型：${rewardTypeKey}`,'warn'); return; }
        const amountRaw=parts[3]!==undefined?parts[3].trim():''; const amountVal=amountRaw?Number(amountRaw):1;
        if(Number.isNaN(amountVal)){ pushToast(`奖励数量无效：${s}`,'warn'); return; }
        reward={type:rewardTypeKey,amount:normalizeRewardAmount(amountVal||1)}; }
      state.tasks.unshift({id:uid(), title, difficulty, totalHQ:0, totalSeconds:0, reward}); imported++; });
    if(imported>0){ save(); renderTasks(); pushToast(`成功导入 ${imported} 个任务`,'success'); el.taskLibraryInput.value=''; } else { pushToast('未导入任何任务','warn'); }
  };

  const openTodayDone = () => { playSound(sfx.modalOpen); renderTodayDone(); el.todayDoneMask.style.display = 'flex'; };
  el.btnTodayDone.onclick = openTodayDone;
  el.btnCloseTodayDone.onclick = () => { playSound(sfx.modalClose); el.todayDoneMask.style.display = 'none'; };
  el.btnSpin.onclick=startNameTicker;
  
  function renderYou() {
    ensureBadgeMeta(); const { avatarUploader, charNameInput, charTitleInput, charLevelText, charTotalHQText } = el;
    const totalHQ = state.agg.totalHQ || 0; const hqForLevelUp = 1000;
    const currentLevel = Math.floor(totalHQ / hqForLevelUp) + 1; const nextLevel = currentLevel + 1;
    const currentLevelBaseHQ = (currentLevel - 1) * hqForLevelUp; const hqInCurrentLevel = totalHQ - currentLevelBaseHQ;
    const hqNeeded = hqForLevelUp - hqInCurrentLevel;
    const expLevelNowEl = document.getElementById("expLevelNow"); const expLevelNextEl = document.getElementById("expLevelNext");
    const expBarFillEl = document.getElementById("expBarFill"); const expValueTextEl = document.getElementById("expValueText");
    const expGapEl = document.querySelector(".exp-bar-info .exp-gap");
    if (expLevelNowEl) expLevelNowEl.textContent = currentLevel; if (expLevelNextEl) expLevelNextEl.textContent = nextLevel;
    if (expBarFillEl) { const percent = Math.min(99.5, (hqInCurrentLevel / hqForLevelUp) * 100); expBarFillEl.style.width = `${percent}%`; }
    if (expValueTextEl) expValueTextEl.textContent = `${Math.floor(hqInCurrentLevel)} / ${hqForLevelUp}`;
    if (expGapEl) expGapEl.textContent = `距下级：${Math.ceil(hqNeeded)} 豪情值`;
    avatarUploader.style.backgroundImage = meta.character.avatar ? `url(${meta.character.avatar})` : 'none';
    if (!meta.character.avatar) avatarUploader.innerHTML = '点击<br>上传头像'; else avatarUploader.innerHTML = '';
    charNameInput.value = meta.character.name; charTitleInput.value = meta.character.title;
    charLevelText.textContent = `Lv. ${currentLevel}`; charTotalHQText.textContent = `${Math.floor(totalHQ).toLocaleString()} HQ`;
  }
  
  if (el.avatarUploader) {
    el.avatarUploader.onclick = () => { if (!auth.currentUser) { pushToast('请先登录', 'warn'); return; } el.avatarInput.click(); };
    const resizeImage = (file, maxWidth, maxHeight, quality) => {
        return new Promise((resolve, reject) => { const reader = new FileReader();
            reader.onload = e => { const img = new Image(); img.onload = () => { let width = img.width; let height = img.height;
                    if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                    const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality)); };
                img.onerror = reject; img.src = e.target.result; };
            reader.onerror = reject; reader.readAsDataURL(file); }); };

    el.avatarInput.onchange = async e => {
      const file = e.target.files[0]; if (!file || !auth.currentUser) return;
      el.avatarUploader.innerHTML = '处理中...'; el.avatarInput.value = '';
      try {
        const resizedDataUrl = await resizeImage(file, 256, 256, 0.8);
        const storageRef = storage.ref(`avatars/${auth.currentUser.uid}.jpg`);
        const uploadTask = await storageRef.putString(resizedDataUrl, 'data_url');
        const downloadURL = await uploadTask.ref.getDownloadURL();
        meta.character.avatar = downloadURL;
        save();
        pushToast('头像已上传并同步', 'success');
        // Firestore listener will update the UI
      } catch (error) {
        console.error("Avatar upload failed:", error);
        pushToast('头像上传失败', 'warn');
        renderYou();
      }
    };
  }

  if (el.charNameInput) { el.charNameInput.onblur = () => { meta.character.name = el.charNameInput.value.trim(); save(); }; }
  if (el.charTitleInput) { el.charTitleInput.onblur = () => { meta.character.title = el.charTitleInput.value.trim(); save(); }; }

  function renderInitial(){ renderTasks(); renderKPI(); renderDaily(); renderInventory(); renderWorkshop(); renderFunshop(); renderYou(); renderHeaderStatus(); hidePauseIndicator(); setControls(); updateModeButton();}

  if(el.btnFunshopEdit) el.btnFunshopEdit.onclick=()=>{ playSound(sfx.modalOpen); const acts=meta.funshop.activities||[];
    const lines=acts.map(a=>{ const need=Object.entries(a.need||{}).map(([k,v])=>`${k}*${v}`).join(',');
      const wear=Object.entries(a.wear||{}).map(([k,v])=>`${k}*${v}`).join(',');
      const win=a.timeWindow?`${a.timeWindow.start}-${a.timeWindow.end}`:'';
      return `${a.title}|${a.seconds}|需求: ${need}|磨损: ${wear}|时段: ${win}`; }).join('\n');
    if(el.funshopInput) el.funshopInput.value=lines; el.funshopEditMask.style.display='flex'; };
  if(el.btnCloseFunshopEdit) el.btnCloseFunshopEdit.onclick=()=>{ playSound(sfx.modalClose); el.funshopEditMask.style.display='none'; };
  if(el.btnFunshopImport) el.btnFunshopImport.onclick=()=>{ playSound(sfx.click); const text=(el.funshopInput.value||'').trim();
    const acts=parseFunshopLines(text); meta.funshop.activities=acts; save(); renderFunshop(); pushToast('已导入娱乐活动','success'); };
  
  const btnCopyFunshopFormat = document.getElementById('btnCopyFunshopFormat');
  if(btnCopyFunshopFormat) { btnCopyFunshopFormat.onclick = () => { playSound(sfx.click);
      const textToCopy = `放松呼吸训练|300|需求: rare_token*1|磨损: rare_token*5|\n豪情轮盘挑战|180|需求: epic_token*1|磨损: epic_token*8|时段: 19:00-23:00\n街机小游园|120|需求: rare_token*1|磨损: rare_token*3,ticket*1|`;
      navigator.clipboard.writeText(textToCopy.trim()).then(() => { pushToast('已复制示例格式到剪贴板', 'success');
      }).catch(err => { pushToast('复制失败', 'warn'); console.error('Copy failed', err); }); }; }
  
  const youPageHelpBtn = document.getElementById('youPageHelpBtn');
  if (youPageHelpBtn) { youPageHelpBtn.onclick = () => { playSound(sfx.modalOpen); if (el.helpMask) el.helpMask.style.display = 'flex'; }; }
  
  const valorChip = document.getElementById('totalValorChip');
  if (valorChip) { let valorClickCount = 0; let valorClickTimer = null;
    valorChip.addEventListener('click', () => { valorClickCount++; if (valorClickTimer) clearTimeout(valorClickTimer);
      valorClickTimer = setTimeout(() => { valorClickCount = 0; }, 600);
      if (valorClickCount === 3) { valorClickCount = 0; clearTimeout(valorClickTimer);
        if (el.devMask) { playSound(sfx.modalOpen);
            el.rate1.value=RATE_BY_DIFFICULTY[1]; el.rate2.value=RATE_BY_DIFFICULTY[2]; el.rate3.value=RATE_BY_DIFFICULTY[3]; el.rate4.value=RATE_BY_DIFFICULTY[4]; el.rate5.value=RATE_BY_DIFFICULTY[5];
            el.devRewardBaseChance.value = REWARD_PARAMS.baseChance; el.devRewardBetCoeff.value = REWARD_PARAMS.betCoefficient;
            el.devRewardMaxChance.value = REWARD_PARAMS.maxChance; el.devRewardPityInc.value = REWARD_PARAMS.pityIncrement;
            ensureBadgeMeta(); const b = meta.badges || {};
            el.devTotalHQ.value = Math.floor(state.agg.totalHQ || 0); el.devTickets.value = meta.tickets || 0;
            el.devFreeze.value = meta.freeze || 0; el.devRareGem.value = b.rare_gem || 0; el.devEpicGem.value = b.epic_gem || 0;
            el.devRareToken.value = b.rare_tokens || 0; el.devEpicToken.value = b.epic_tokens || 0; el.devLegendToken.value = b.legendary_tokens || 0;
            el.devMask.style.display = 'flex'; } } }); }
  
  if (el.btnSaveResources) { el.btnSaveResources.onclick = () => { playSound(sfx.click); const p = s => parseInt(s, 10) || 0;
      state.agg.totalHQ = p(el.devTotalHQ.value); meta.tickets = p(el.devTickets.value); meta.freeze = p(el.devFreeze.value);
      ensureBadgeMeta(); meta.badges.rare_gem = p(el.devRareGem.value); meta.badges.epic_gem = p(el.devEpicGem.value);
      meta.badges.rare_tokens = p(el.devRareToken.value); meta.badges.epic_tokens = p(el.devEpicToken.value);
      meta.badges.legendary_tokens = p(el.devLegendToken.value);
      save(); renderKPI(); renderInventory(); pushToast('资源已更新', 'success'); }; }

  if (el.btnSaveRewardParams) { el.btnSaveRewardParams.onclick = () => { playSound(sfx.click); const p = s => parseFloat(s) || 0;
      REWARD_PARAMS.baseChance = p(el.devRewardBaseChance.value); REWARD_PARAMS.betCoefficient = p(el.devRewardBetCoeff.value);
      REWARD_PARAMS.maxChance = p(el.devRewardMaxChance.value); REWARD_PARAMS.pityIncrement = p(el.devRewardPityInc.value);
      save(); pushToast('奖励赔率已保存', 'success'); }; }
  
  if (el.btnResetRewardParams) { el.btnResetRewardParams.onclick = () => { playSound(sfx.click); REWARD_PARAMS = { ...DEFAULT_REWARD_PARAMS };
      el.devRewardBaseChance.value = REWARD_PARAMS.baseChance; el.devRewardBetCoeff.value = REWARD_PARAMS.betCoefficient;
      el.devRewardMaxChance.value = REWARD_PARAMS.maxChance; el.devRewardPityInc.value = REWARD_PARAMS.pityIncrement;
      save(); pushToast('已恢复默认赔率', 'success'); }; }

  if (el.btnSimulateNextDay) { el.btnSimulateNextDay.onclick = () => { playSound(sfx.click); window._debugDateOffset = (window._debugDateOffset || 0) + 1; renderInitial(); pushToast(`已模拟到下一天 (${getToday().toLocaleDateString()})`, 'success'); }; }
  if (el.btnResetDaily) { el.btnResetDaily.onclick = () => { playSound(sfx.click); const d = todayObj();
          d.progressSec = 0; d.hardSec = 0; d.sessions = 0; d.zeroPauseSessions = 0; d.missions = null; d.refreshUsed = false; d.done = {};
          rollMissions(true); save(); renderDaily(); pushToast('每日进度已重置', 'success'); }; }
  
  if (el.btnHardReset) { el.btnHardReset.onclick = () => { playSound(sfx.warn);
          if (confirm('危险操作：这将清除此浏览器中的所有应用数据，确定吗？')) { Object.values(LS_KEYS).forEach(k => { localStore.removeItem(k); }); window._debugDateOffset = 0; location.reload(); } }; }
  
  if (el.btnExportState) { el.btnExportState.onclick = () => { playSound(sfx.click);
      const fullState = { tasks: state.tasks, agg: state.agg, meta: meta, rates: RATE_BY_DIFFICULTY, funshop: FUNSHOP, rewardParams: REWARD_PARAMS, active: state.active };
      el.devStateText.value = JSON.stringify(fullState, null, 2); pushToast('状态已导出到文本框。'); }; }
  
  if (el.btnImportState) { el.btnImportState.onclick = () => { playSound(sfx.click); const json = el.devStateText.value;
      if (!json) { pushToast('导入框为空。', 'warn'); return; }
      try { const imported = JSON.parse(json); 
        state.tasks = imported.tasks || []; state.agg = imported.agg || {totalHQ: 0, totalSeconds: 0}; state.active = imported.active || null;
        meta = imported.meta || getInitialMeta(); RATE_BY_DIFFICULTY = imported.rates || DEFAULT_RATES;
        FUNSHOP = imported.funshop || FUNSHOP; REWARD_PARAMS = imported.rewardParams || DEFAULT_REWARD_PARAMS;
        save(); renderInitial(); pushToast('状态导入成功！', 'success'); el.devStateText.value = '';
      } catch (e) { pushToast('解析JSON时出错，请检查控制台。', 'warn'); console.error("Import Error:", e); } }; }
  
  const btnToggleSound = document.getElementById('btnToggleSound');
  function updateSoundButton() { if (btnToggleSound) { btnToggleSound.textContent = `音效：${isSoundMuted ? '关闭' : '开启'}`; } }
  if(btnToggleSound){ btnToggleSound.onclick = () => { isSoundMuted = !isSoundMuted; writeJSON(LS_KEYS.SOUND_MUTED, isSoundMuted); updateSoundButton(); if (!isSoundMuted) { playSound(sfx.click); } }; updateSoundButton(); }
  
  /* ================================
   *        Firebase Auth & Sync
   * ================================ */
  const showLoader = (text) => { if(el.loadingOverlay) { el.loadingOverlay.textContent = text; el.loadingOverlay.style.display = 'flex'; }};
  const hideLoader = () => { if(el.loadingOverlay) el.loadingOverlay.style.display = 'none'; };

  const signIn = () => {
    auth.signInWithPopup(googleProvider).catch(error => {
        console.error("Google Sign-In Error:", error);
        pushToast(`登录失败: ${error.message}`, 'warn');
    });
  };
  const signOut = () => {
    auth.signOut();
  };

  el.btnLogin.onclick = signIn;
  el.btnLogout.onclick = signOut;

  const setupFirestoreListener = (uid) => {
    if (firestoreUnsubscribe) {
        firestoreUnsubscribe();
    }
    const docRef = db.collection('users').doc(uid);
    firestoreUnsubscribe = docRef.onSnapshot(doc => {
        if (doc.exists) {
            applyCloudData(doc.data());
        } else {
            // First time user, create their document with local state
            console.log("New user, creating document in Firestore.");
            const fullState = { tasks: state.tasks, agg: state.agg, active: state.active, meta: meta, rates: RATE_BY_DIFFICULTY, funshop: FUNSHOP, rewardParams: REWARD_PARAMS };
            docRef.set(fullState);
        }
        hideLoader();
    }, error => {
        console.error("Firestore listener error:", error);
        pushToast('与云端同步时出错', 'warn');
        hideLoader();
    });
  };

  auth.onAuthStateChanged(user => {
    if (user) {
        // User is signed in.
        el.authChipWrapper.classList.add('logged-in');
        el.authStatusText.textContent = user.displayName || '已登录';
        el.userAvatar.style.backgroundImage = user.photoURL ? `url(${user.photoURL})` : 'none';
        showLoader('同步云端数据...');
        setupFirestoreListener(user.uid);
    } else {
        // User is signed out.
        if (firestoreUnsubscribe) {
            firestoreUnsubscribe();
            firestoreUnsubscribe = null;
        }
        el.authChipWrapper.classList.remove('logged-in');
        resetLocalState();
        hideLoader();
    }
  });

  // App Initialization
  loadStateFromLocalStorage();
  renderInitial();
  loop();
  tickFunshopTimers();
});
</script>

</body>
</html>
